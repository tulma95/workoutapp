# Remove T1/T2 Tier System — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Remove the T1/T2 tier column from the database and all code, replacing it with exercise_order on workout_sets and grouping by exercise on the frontend.

**Architecture:** Drop `tier` from `plan_day_exercises` and `workout_sets`. Add `exercise_order` to `workout_sets` (copied from `plan_day_exercises.sort_order` at generation time). Frontend groups sets by exerciseId instead of filtering by tier string. `set_order` stays per-exercise (1-based).

**Tech Stack:** Prisma v7 migrations, Express/TypeScript backend, React/TypeScript frontend, Playwright E2E

---

### Task 1: Database Migration — Drop tier, add exercise_order

**Files:**
- Modify: `backend/prisma/schema.prisma:61-77` (PlanDayExercise model)
- Modify: `backend/prisma/schema.prisma:142-161` (WorkoutSet model)
- Create: migration file (auto-generated by Prisma)

**Step 1: Update Prisma schema — PlanDayExercise**

In `backend/prisma/schema.prisma`, remove the `tier` line from PlanDayExercise (line 65):

```prisma
model PlanDayExercise {
  id           Int     @id @default(autoincrement())
  planDayId    Int     @map("plan_day_id")
  exerciseId   Int     @map("exercise_id")
  sortOrder    Int     @map("sort_order")
  tmExerciseId Int     @map("tm_exercise_id")
  displayName  String? @map("display_name")

  planDay    PlanDay   @relation(fields: [planDayId], references: [id], onDelete: Cascade)
  exercise   Exercise  @relation("exercise", fields: [exerciseId], references: [id])
  tmExercise Exercise  @relation("tmExerciseRef", fields: [tmExerciseId], references: [id])
  sets       PlanSet[]

  @@unique([planDayId, sortOrder])
  @@map("plan_day_exercises")
}
```

**Step 2: Update Prisma schema — WorkoutSet**

Replace `tier String` with `exerciseOrder Int @map("exercise_order")` and update the index:

```prisma
model WorkoutSet {
  id               Int      @id @default(autoincrement())
  workoutId        Int      @map("workout_id")
  exerciseId       Int      @map("exercise_id")
  exerciseOrder    Int      @map("exercise_order")
  setOrder         Int      @map("set_order")
  prescribedWeight Decimal  @db.Decimal(6, 2) @map("prescribed_weight")
  prescribedReps   Int      @map("prescribed_reps")
  isAmrap          Boolean  @default(false) @map("is_amrap")
  isProgression    Boolean  @default(false) @map("is_progression")
  actualReps       Int?     @map("actual_reps")
  completed        Boolean  @default(false)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  workout  Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id])

  @@index([workoutId, exerciseOrder, setOrder])
  @@map("workout_sets")
}
```

**Step 3: Generate and run migration**

```bash
cd backend
export DATABASE_URL=postgresql://treenisofta:treenisofta_dev@localhost:5432/treenisofta
npx prisma migrate dev --name remove-tier-add-exercise-order
```

The migration will:
1. Drop `tier` column from `plan_day_exercises`
2. Drop `tier` column and old index from `workout_sets`
3. Add `exercise_order` column and new index to `workout_sets`

If Prisma warns about data loss (it will for existing rows), that's expected — the tier column is being dropped. For `exercise_order`, existing workout_sets rows need a default. Edit the generated migration SQL to set `exercise_order` based on existing data before making it NOT NULL:

```sql
-- Add exercise_order as nullable first
ALTER TABLE "workout_sets" ADD COLUMN "exercise_order" INTEGER;

-- Populate from existing tier: T1 -> 1, T2 -> 2
UPDATE "workout_sets" SET "exercise_order" = CASE WHEN "tier" = 'T1' THEN 1 WHEN "tier" = 'T2' THEN 2 ELSE 1 END;

-- Make NOT NULL
ALTER TABLE "workout_sets" ALTER COLUMN "exercise_order" SET NOT NULL;

-- Drop tier
ALTER TABLE "workout_sets" DROP COLUMN "tier";
ALTER TABLE "plan_day_exercises" DROP COLUMN "tier";

-- Drop old index, create new
DROP INDEX IF EXISTS "workout_sets_workout_id_tier_set_order_idx";
CREATE INDEX "workout_sets_workout_id_exercise_order_set_order_idx" ON "workout_sets"("workout_id", "exercise_order", "set_order");
```

**Step 4: Regenerate Prisma client**

```bash
cd backend && npx prisma generate
```

**Step 5: Commit**

```bash
git add backend/prisma/schema.prisma backend/prisma/migrations/
git commit -m "db: remove tier column, add exercise_order to workout_sets"
```

---

### Task 2: Backend — Update workout service

**Files:**
- Modify: `backend/src/services/workout.service.ts`

**Step 1: Update formatWorkout type (line 37)**

Remove `tier: string;` from the sets type in `formatWorkout`. Add `exerciseOrder: number;`.

Before:
```typescript
      tier: string;
      setOrder: number;
```

After:
```typescript
      exerciseOrder: number;
      setOrder: number;
```

**Step 2: Update setsToCreate type (lines 150-158)**

Replace `tier: string;` with `exerciseOrder: number;`:

```typescript
    const setsToCreate: Array<{
      exerciseId: number;
      exerciseOrder: number;
      setOrder: number;
      prescribedWeight: number;
      prescribedReps: number;
      isAmrap: boolean;
      isProgression: boolean;
    }> = [];
```

**Step 3: Update set generation (line 167)**

Replace `tier: planDayExercise.tier,` with `exerciseOrder: planDayExercise.sortOrder,`:

```typescript
        setsToCreate.push({
          exerciseId: planDayExercise.exerciseId,
          exerciseOrder: planDayExercise.sortOrder,
          setOrder: planSet.setOrder,
```

**Step 4: Update workout set creation (line 193)**

Replace `tier: set.tier,` with `exerciseOrder: set.exerciseOrder,`:

```typescript
          data: {
            workoutId: w.id,
            exerciseId: set.exerciseId,
            exerciseOrder: set.exerciseOrder,
            setOrder: set.setOrder,
```

**Step 5: Update ALL orderBy clauses**

Replace every `[{ tier: 'asc' }, { setOrder: 'asc' }]` with `[{ exerciseOrder: 'asc' }, { setOrder: 'asc' }]`.

Locations (7 total):
- Line 207 (startWorkout return query)
- Line 239 (getCurrentWorkout)
- Line 258 (getWorkout)
- Line 313 (completeWorkout — find workout)
- Line 436 (completeWorkout — update/return)
- Line 459 (completeWorkout — no-plan path)
- Line 489 (getHistory)

**Step 6: Verify build**

```bash
npm run build -w backend
```

**Step 7: Commit**

```bash
git add backend/src/services/workout.service.ts
git commit -m "backend: replace tier with exerciseOrder in workout service"
```

---

### Task 3: Backend — Update admin plans route and seed

**Files:**
- Modify: `backend/src/routes/admin/plans.ts:22-29` (planDayExerciseSchema)
- Modify: `backend/src/routes/admin/plans.ts:77` (create plan)
- Modify: `backend/src/routes/admin/plans.ts:275` (update plan)
- Modify: `backend/prisma/seed.ts` (8 occurrences of `tier`)

**Step 1: Remove tier from Zod schema (line 24)**

In `backend/src/routes/admin/plans.ts`, remove `tier: z.string().min(1),` from `planDayExerciseSchema`:

```typescript
const planDayExerciseSchema = z.object({
  exerciseId: z.number().int(),
  sortOrder: z.number().int().min(1),
  tmExerciseId: z.number().int(),
  displayName: z.string().optional(),
  sets: z.array(planSetSchema).min(1),
});
```

**Step 2: Remove tier from create plan (line 77)**

Remove `tier: exercise.tier,` from the `planDayExercise.create` data block:

```typescript
          const createdExercise = await tx.planDayExercise.create({
            data: {
              planDayId: createdDay.id,
              exerciseId: exercise.exerciseId,
              sortOrder: exercise.sortOrder,
              tmExerciseId: exercise.tmExerciseId,
              displayName: exercise.displayName,
            },
          });
```

**Step 3: Remove tier from update plan (line 275)**

Same removal in the PUT handler:

```typescript
          const createdExercise = await tx.planDayExercise.create({
            data: {
              planDayId: createdDay.id,
              exerciseId: exercise.exerciseId,
              sortOrder: exercise.sortOrder,
              tmExerciseId: exercise.tmExerciseId,
              displayName: exercise.displayName,
            },
          });
```

**Step 4: Remove tier from seed data**

In `backend/prisma/seed.ts`, remove every `tier: 'T1',` and `tier: 'T2',` line (8 total at lines 245, 279, 322, 355, 398, 432, 475, 508).

**Step 5: Verify build**

```bash
npm run build -w backend
```

**Step 6: Commit**

```bash
git add backend/src/routes/admin/plans.ts backend/prisma/seed.ts
git commit -m "backend: remove tier from admin plans route and seed data"
```

---

### Task 4: Frontend — Update API types and schemas

**Files:**
- Modify: `frontend/src/api/schemas.ts:8` (WorkoutSetSchema)
- Modify: `frontend/src/api/plans.ts:16` (PlanDayExercise interface)
- Modify: `frontend/src/api/adminPlans.ts:17,59` (PlanDayExerciseInput, PlanWithDetails)

**Step 1: Update WorkoutSetSchema**

In `frontend/src/api/schemas.ts`, replace `tier: z.string(),` with `exerciseOrder: z.number(),`:

```typescript
export const WorkoutSetSchema = z.object({
  id: z.number(),
  workoutId: z.number(),
  exercise: z.string(),
  exerciseOrder: z.number(),
  setOrder: z.number(),
  prescribedWeight: z.number(),
  prescribedReps: z.number(),
  isAmrap: z.boolean(),
  isProgression: z.boolean().optional(),
  actualReps: z.number().nullable(),
  completed: z.boolean(),
  createdAt: z.string(),
});
```

**Step 2: Remove tier from PlanDayExercise (plans.ts:16)**

In `frontend/src/api/plans.ts`, remove `tier: string;`:

```typescript
export interface PlanDayExercise {
  id: number;
  planDayId: number;
  exerciseId: number;
  sortOrder: number;
  tmExerciseId: number;
  displayName: string | null;
  exercise: Exercise;
  tmExercise: Exercise;
}
```

**Step 3: Remove tier from PlanDayExerciseInput (adminPlans.ts:17)**

```typescript
export interface PlanDayExerciseInput {
  exerciseId: number;
  sortOrder: number;
  tmExerciseId: number;
  displayName?: string;
  sets: PlanSet[];
}
```

**Step 4: Remove tier from PlanWithDetails (adminPlans.ts:59)**

Remove `tier: string;` from the nested exercises type.

**Step 5: Verify typecheck**

```bash
cd frontend && npx tsc --noEmit
```

This will show remaining tier references that need fixing in later tasks.

**Step 6: Commit**

```bash
git add frontend/src/api/schemas.ts frontend/src/api/plans.ts frontend/src/api/adminPlans.ts
git commit -m "frontend: remove tier from API types and schemas"
```

---

### Task 5: Frontend — Update WorkoutPage (group by exercise)

**Files:**
- Modify: `frontend/src/pages/WorkoutPage.tsx:291-360`

**Step 1: Replace tier filtering with exercise grouping**

Replace lines 291-297:

```typescript
  const t1Sets = workout.sets.filter((s) => s.tier === 'T1')
  const t2Sets = workout.sets.filter((s) => s.tier === 'T2')
  const unit = user?.unitPreference || 'kg'

  // Extract exercise names from workout sets
  const t1ExerciseName = t1Sets.length > 0 ? t1Sets[0].exercise : 'T1'
  const t2ExerciseName = t2Sets.length > 0 ? t2Sets[0].exercise : 'T2'
```

With:

```typescript
  const unit = user?.unitPreference || 'kg'

  // Group sets by exercise, preserving exerciseOrder
  const exerciseGroups: Array<{ exercise: string; sets: typeof workout.sets }> = []
  for (const set of workout.sets) {
    const last = exerciseGroups[exerciseGroups.length - 1]
    if (last && last.exercise === set.exercise) {
      last.sets.push(set)
    } else {
      exerciseGroups.push({ exercise: set.exercise, sets: [set] })
    }
  }
```

**Step 2: Replace the two hardcoded sections with a map**

Replace the two `<section className="workout-section">` blocks (lines 318-360) with:

```tsx
      {exerciseGroups.map((group) => (
        <section key={group.exercise} className="workout-section">
          <h2 className="workout-section__title">{group.exercise}</h2>
          <div className="workout-section__sets">
            {group.sets.map((set, index) => (
              <SetRow
                key={set.id}
                setNumber={index + 1}
                weight={set.prescribedWeight}
                reps={set.prescribedReps}
                isAmrap={set.isAmrap}
                completed={set.completed}
                actualReps={set.actualReps}
                unit={unit}
                onComplete={() => handleSetComplete(set.id)}
                onAmrapRepsChange={(reps) =>
                  handleAmrapRepsChange(set.id, reps)
                }
              />
            ))}
          </div>
        </section>
      ))}
```

**Step 3: Verify typecheck**

```bash
cd frontend && npx tsc --noEmit
```

**Step 4: Commit**

```bash
git add frontend/src/pages/WorkoutPage.tsx
git commit -m "frontend: group workout sets by exercise instead of tier"
```

---

### Task 6: Frontend — Update WorkoutDetail component

**Files:**
- Modify: `frontend/src/components/WorkoutDetail.tsx:1-100`

**Step 1: Remove WORKOUT_DAYS constant (lines 8-13)**

Delete the entire hardcoded array:

```typescript
const WORKOUT_DAYS = [
  { day: 1, t1: 'Bench Volume', t2: 'OHP' },
  { day: 2, t1: 'Squat', t2: 'Sumo Deadlift' },
  { day: 3, t1: 'Bench Heavy', t2: 'Close Grip Bench' },
  { day: 4, t1: 'Deadlift', t2: 'Front Squat' },
];
```

**Step 2: Replace tier filtering with exercise grouping**

Replace the `dayInfo` lookup (line 47) and `t1Sets`/`t2Sets` (lines 56-57) with:

```typescript
  // Group sets by exercise, preserving exerciseOrder
  const exerciseGroups: Array<{ exercise: string; sets: typeof workout.sets }> = [];
  for (const set of workout.sets) {
    const last = exerciseGroups[exerciseGroups.length - 1];
    if (last && last.exercise === set.exercise) {
      last.sets.push(set);
    } else {
      exerciseGroups.push({ exercise: set.exercise, sets: [set] });
    }
  }
```

**Step 3: Update the render**

Remove the `dayInfo` check (lines 47-54). Update the title to use the first exercise name. Replace the two hardcoded T1/T2 sections with a map over `exerciseGroups`:

```tsx
  return (
    <div className="workout-detail">
      <div className="workout-detail__header">
        <h2 className="workout-detail__title">
          Day {workout.dayNumber}{exerciseGroups.length > 0 ? ` - ${exerciseGroups[0].exercise}` : ''}
        </h2>
        <p className="workout-detail__date">{formatDate(workoutDate)}</p>
      </div>

      {exerciseGroups.map((group) => (
        <section key={group.exercise} className="workout-detail__section">
          <h3 className="workout-detail__section-title">{group.exercise}</h3>
          <div className="workout-detail__sets">
            {group.sets.map((set, index) => (
              <div key={set.id} className="workout-detail__set-row">
                <span className="workout-detail__set-number">Set {index + 1}</span>
                <span className="workout-detail__set-weight">
                  {formatWeight(set.prescribedWeight, unit)}
                </span>
                <span className="workout-detail__set-reps">
                  {set.prescribedReps}
                  {set.isAmrap ? '+' : ''} reps
                </span>
                {set.actualReps !== null && (
                  <span className="workout-detail__set-actual">
                    ({set.actualReps} done)
                  </span>
                )}
                {set.completed && (
                  <span className="workout-detail__set-completed" aria-label="completed">
                    ✓
                  </span>
                )}
              </div>
            ))}
          </div>
        </section>
      ))}

      {/* Keep existing ProgressionBanner usage as-is */}
    </div>
  );
```

**Step 4: Verify typecheck**

```bash
cd frontend && npx tsc --noEmit
```

**Step 5: Commit**

```bash
git add frontend/src/components/WorkoutDetail.tsx
git commit -m "frontend: replace hardcoded WORKOUT_DAYS with dynamic exercise grouping"
```

---

### Task 7: Frontend — Update DashboardPage and WorkoutCard

**Files:**
- Modify: `frontend/src/components/WorkoutCard.tsx`
- Modify: `frontend/src/pages/DashboardPage.tsx:191-213`

**Step 1: Update WorkoutCard props**

Replace `t1Exercise`/`t2Exercise` with `exercises: string[]`:

```typescript
interface WorkoutCardProps {
  dayNumber: number;
  exercises: string[];
  status: 'upcoming' | 'in_progress' | 'completed';
  onStart: (dayNumber: number) => void;
}

export default function WorkoutCard({
  dayNumber,
  exercises,
  status,
  onStart,
}: WorkoutCardProps) {
  return (
    <div className={`workout-card workout-card--${status}`}>
      <div className="workout-card__header">
        <h3 className="workout-card__title">Day {dayNumber}</h3>
        {status === 'completed' && (
          <span className="workout-card__checkmark">✓</span>
        )}
      </div>

      <div className="workout-card__exercises">
        {exercises.map((name) => (
          <div key={name} className="workout-card__exercise">
            <span className="workout-card__name">{name}</span>
          </div>
        ))}
      </div>

      {status !== 'completed' && (
        <button
          className="btn-primary workout-card__button"
          onClick={() => onStart(dayNumber)}
        >
          {status === 'in_progress' ? 'Continue Workout' : 'Start Workout'}
        </button>
      )}
    </div>
  );
}
```

**Step 2: Update DashboardPage (lines 191-213)**

Replace the T1/T2 exercise finding with listing all exercises:

```tsx
          {activePlan?.days.map((day) => {
            const exerciseNames = day.exercises.map(
              (ex) => ex.displayName || ex.exercise.name
            );

            return (
              <WorkoutCard
                key={day.dayNumber}
                dayNumber={day.dayNumber}
                exercises={exerciseNames}
                status={getWorkoutStatus(day.dayNumber)}
                onStart={handleStartWorkout}
              />
            );
          })}
```

**Step 3: Verify typecheck**

```bash
cd frontend && npx tsc --noEmit
```

**Step 4: Commit**

```bash
git add frontend/src/components/WorkoutCard.tsx frontend/src/pages/DashboardPage.tsx
git commit -m "frontend: update WorkoutCard and Dashboard to list exercises generically"
```

---

### Task 8: Frontend — Update PlanSelectionPage and PlanEditorPage

**Files:**
- Modify: `frontend/src/pages/PlanSelectionPage.tsx:196`
- Modify: `frontend/src/pages/PlanSelectionPage.css:98-110`
- Modify: `frontend/src/pages/admin/PlanEditorPage.tsx:101,200,552-563`

**Step 1: Remove tier badge from PlanSelectionPage (line 196)**

Replace:
```tsx
                      <div key={ex.id} className="exercise-item">
                        <span className="tier-badge">{ex.tier}</span>
                        <span className="exercise-name">
                          {ex.displayName || ex.exercise.name}
                        </span>
                      </div>
```

With:
```tsx
                      <div key={ex.id} className="exercise-item">
                        <span className="exercise-name">
                          {ex.displayName || ex.exercise.name}
                        </span>
                      </div>
```

**Step 2: Remove .tier-badge CSS**

Delete the `.tier-badge` rule from `frontend/src/pages/PlanSelectionPage.css` (lines 98-110).

**Step 3: Remove tier from PlanEditorPage**

In `frontend/src/pages/admin/PlanEditorPage.tsx`:

- Line 101: Remove `tier: ex.tier,` from the editor state loading
- Line 200: Remove `tier: 'T1',` from `addExerciseToDay`
- Lines 552-563: Remove the entire Tier `<label>` / `<select>` block

**Step 4: Verify typecheck**

```bash
cd frontend && npx tsc --noEmit
```

**Step 5: Commit**

```bash
git add frontend/src/pages/PlanSelectionPage.tsx frontend/src/pages/PlanSelectionPage.css frontend/src/pages/admin/PlanEditorPage.tsx
git commit -m "frontend: remove tier from plan selection and plan editor"
```

---

### Task 9: Update backend tests

**Files:**
- Modify: `backend/src/__tests__/routes/plans.test.ts`
- Modify: `backend/src/__tests__/routes/admin/plans.test.ts`
- Modify: `backend/src/__tests__/routes/admin/exercises.test.ts`
- Modify: `backend/src/__tests__/trainingMaxes.test.ts`
- Modify: `backend/src/__tests__/workouts-plan-driven.test.ts`
- Modify: `backend/src/__tests__/workoutCompletion-plan-driven.test.ts`

**Step 1: Remove all `tier:` from test plan/exercise creation**

In every test file that creates PlanDayExercise records, remove the `tier: 'T1'` and `tier: 'T2'` fields.

**Step 2: Update tier-based assertions**

In `workouts-plan-driven.test.ts`:
- Lines 201-202: Replace `s.tier === 'T1'`/`s.tier === 'T2'` filtering with `s.exerciseOrder === 1` / `s.exerciseOrder === 2`
- Line 214, 297: Replace `expect(progressionSets[0].tier).toBe('T1')` with `expect(progressionSets[0].exerciseOrder).toBe(1)`

In `workoutCompletion-plan-driven.test.ts`:
- Lines 208-209: Replace `s.tier === 'T1'` filtering with `s.exerciseOrder === 1`
- Line 295: Same replacement

In `admin/plans.test.ts`:
- Lines 174-175: Remove `expect(res.body.days[0].exercises[0].tier).toBe('T1')` and similar assertions

**Step 3: Run backend tests**

```bash
./run_test.sh
```

**Step 4: Fix any remaining failures and re-run**

**Step 5: Commit**

```bash
git add backend/src/__tests__/
git commit -m "test: update backend tests to remove tier references"
```

---

### Task 10: Update E2E tests

**Files:**
- Modify: `e2e/workout.spec.ts`

**Step 1: Update test names and assertions**

- Line 4: Rename test from "shows T1 and T2 sections" to "shows exercise sections with correct set counts"
- Lines 310-318: Replace `T1:`/`T2:` heading selectors with exercise name headings. After the change, sections will have headings like "Bench Press" and "OHP" instead of "T1: Bench Press". Update selectors:

```typescript
    // Find first exercise section (Bench Press)
    const firstSection = page.locator('.workout-section').first();
    const secondSection = page.locator('.workout-section').nth(1);
```

- Line 296: Update test name
- Lines 324-343: Update to use positional section selectors instead of T1/T2 headings

**Step 2: Run full test suite**

```bash
./run_test.sh
```

**Step 3: Fix any failures and re-run**

**Step 4: Commit**

```bash
git add e2e/
git commit -m "test: update E2E tests for exercise-grouped workout display"
```

---

### Task 11: Update CLAUDE.md and clean up

**Files:**
- Modify: `CLAUDE.md`

**Step 1: Update CLAUDE.md**

Remove all references to T1/T2 tier from:
- The nSuns table (remove "T1" / "T2" column labels, describe exercises by sort order)
- The Database Schema section (remove `tier` from `plan_day_exercises` and `workout_sets`, add `exercise_order` to `workout_sets`)
- The "Exercise names vs slugs" gotcha note mentioning tier

**Step 2: Run full test suite one final time**

```bash
./run_test.sh
```

**Step 3: Commit**

```bash
git add CLAUDE.md
git commit -m "docs: update CLAUDE.md to reflect tier removal"
```
