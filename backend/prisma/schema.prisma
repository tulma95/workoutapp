generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Exercise {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  name        String
  muscleGroup String?  @map("muscle_group")
  category    String   @default("compound")
  isUpperBody Boolean  @default(false) @map("is_upper_body")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  planDayExercises   PlanDayExercise[]     @relation("exercise")
  tmPlanDayExercises PlanDayExercise[]     @relation("tmExerciseRef")
  progressionRules   PlanProgressionRule[]
  trainingMaxes      TrainingMax[]
  workoutSets        WorkoutSet[]

  @@map("exercises")
}

model WorkoutPlan {
  id           Int       @id @default(autoincrement())
  slug         String    @unique
  name         String
  description  String?
  daysPerWeek  Int       @map("days_per_week")
  isPublic     Boolean   @default(true) @map("is_public")
  isSystem     Boolean   @default(false) @map("is_system")
  archivedAt   DateTime? @map("archived_at") @db.Timestamptz(3)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)

  days              PlanDay[]
  progressionRules  PlanProgressionRule[]
  subscriptions     UserPlan[]

  @@map("workout_plans")
}

model PlanDay {
  id        Int     @id @default(autoincrement())
  planId    Int     @map("plan_id")
  dayNumber Int     @map("day_number")
  name      String?

  plan      WorkoutPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  exercises PlanDayExercise[]
  workouts  Workout[]

  @@unique([planId, dayNumber])
  @@map("plan_days")
}

model PlanDayExercise {
  id           Int     @id @default(autoincrement())
  planDayId    Int     @map("plan_day_id")
  exerciseId   Int     @map("exercise_id")
  sortOrder    Int     @map("sort_order")
  tmExerciseId Int     @map("tm_exercise_id")
  displayName  String? @map("display_name")

  planDay    PlanDay   @relation(fields: [planDayId], references: [id], onDelete: Cascade)
  exercise   Exercise  @relation("exercise", fields: [exerciseId], references: [id])
  tmExercise Exercise  @relation("tmExerciseRef", fields: [tmExerciseId], references: [id])
  sets       PlanSet[]

  @@unique([planDayId, sortOrder])
  @@map("plan_day_exercises")
}

model PlanSet {
  id                 Int     @id @default(autoincrement())
  planDayExerciseId  Int     @map("plan_day_exercise_id")
  setOrder           Int     @map("set_order")
  percentage         Decimal @db.Decimal(5, 4)
  reps               Int
  isAmrap            Boolean @default(false) @map("is_amrap")
  isProgression      Boolean @default(false) @map("is_progression")

  planDayExercise PlanDayExercise @relation(fields: [planDayExerciseId], references: [id], onDelete: Cascade)

  @@unique([planDayExerciseId, setOrder])
  @@map("plan_sets")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  displayName  String   @map("display_name")
  isAdmin      Boolean  @default(false) @map("is_admin")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  trainingMaxes    TrainingMax[]
  workouts         Workout[]
  plans            UserPlan[]
  sentRequests     Friendship[] @relation("SentRequests")
  receivedRequests Friendship[] @relation("ReceivedRequests")
  feedEvents       FeedEvent[]

  @@map("users")
}

model TrainingMax {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  exerciseId    Int      @map("exercise_id")
  workoutId     Int?     @map("workout_id")
  weight        Decimal  @db.Decimal(6, 2)
  previousWeight Decimal? @map("previous_weight") @db.Decimal(6, 2)
  effectiveDate DateTime @default(now()) @map("effective_date") @db.Timestamptz(3)
  reason        String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  user     User     @relation(fields: [userId], references: [id])
  exercise Exercise @relation(fields: [exerciseId], references: [id])
  workout  Workout? @relation(fields: [workoutId], references: [id])

  @@unique([userId, exerciseId, effectiveDate])
  @@map("training_maxes")
}

model Workout {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  dayNumber   Int       @map("day_number")
  planDayId   Int?      @map("plan_day_id")
  status      String    @default("in_progress")
  completedAt DateTime? @map("completed_at") @db.Timestamptz(3)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)

  user         User          @relation(fields: [userId], references: [id])
  planDay      PlanDay?      @relation(fields: [planDayId], references: [id])
  sets         WorkoutSet[]
  progressions TrainingMax[]

  @@index([userId, status])
  @@map("workouts")
}

model WorkoutSet {
  id               Int      @id @default(autoincrement())
  workoutId        Int      @map("workout_id")
  exerciseId       Int      @map("exercise_id")
  exerciseOrder    Int      @map("exercise_order")
  setOrder         Int      @map("set_order")
  prescribedWeight Decimal  @db.Decimal(6, 2) @map("prescribed_weight")
  prescribedReps   Int      @map("prescribed_reps")
  isAmrap          Boolean  @default(false) @map("is_amrap")
  isProgression    Boolean  @default(false) @map("is_progression")
  actualReps       Int?     @map("actual_reps")
  completed        Boolean  @default(false)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  workout  Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id])

  @@index([workoutId, exerciseOrder, setOrder])
  @@map("workout_sets")
}

model PlanProgressionRule {
  id         Int      @id @default(autoincrement())
  planId     Int      @map("plan_id")
  exerciseId Int?     @map("exercise_id")
  category   String?
  minReps    Int      @map("min_reps")
  maxReps    Int      @map("max_reps")
  increase   Decimal  @db.Decimal(5, 2)

  plan     WorkoutPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  exercise Exercise?   @relation(fields: [exerciseId], references: [id])

  @@map("plan_progression_rules")
}

model UserPlan {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  planId    Int       @map("plan_id")
  isActive  Boolean   @default(true) @map("is_active")
  startedAt DateTime  @default(now()) @map("started_at") @db.Timestamptz(3)
  endedAt   DateTime? @map("ended_at") @db.Timestamptz(3)

  user     User               @relation(fields: [userId], references: [id])
  plan     WorkoutPlan        @relation(fields: [planId], references: [id])
  schedule UserPlanSchedule[]

  @@index([userId])
  @@map("user_plans")
}

model UserPlanSchedule {
  id         Int      @id @default(autoincrement())
  userPlanId Int      @map("user_plan_id")
  dayNumber  Int      @map("day_number")
  weekday    Int
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  userPlan UserPlan @relation(fields: [userPlanId], references: [id], onDelete: Cascade)

  @@unique([userPlanId, dayNumber])
  @@map("user_plan_schedules")
}

model Friendship {
  id          Int      @id @default(autoincrement())
  requesterId Int      @map("requester_id")
  addresseeId Int      @map("addressee_id")
  status      String   @default("pending") @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  requester User @relation("SentRequests", fields: [requesterId], references: [id])
  addressee User @relation("ReceivedRequests", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@map("friendships")
}

model FeedEvent {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  eventType String   @map("event_type") @db.Text
  payload   Json
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@map("feed_events")
}
