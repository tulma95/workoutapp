# Ralph Progress Log
---
## Codebase Patterns
- Environment variables are exported by shell scripts, never loaded from .env files
- All scripts source scripts/common.sh for shared helpers (ensure_dependencies)
- Backend reads process.env directly without dotenv
- prisma.config.ts reads process.env["DATABASE_URL"] without dotenv/config import
- Checksum of package-lock.json stored at node_modules/.package-lock-checksum to detect stale dependencies
- Prisma CLI does NOT support npm workspace `-w` flag — must `cd backend` then run `npx prisma generate` / `npx prisma migrate dev`
---

## 2026-02-12 - US-001
- Removed all dotenv dependencies and .env files
- Modified backend/src/config.ts: removed dotenv import and dotenv.config() call
- Modified backend/src/lib/db.ts: removed dotenv import and dotenv.config() call
- Modified backend/prisma.config.ts: removed "dotenv/config" import
- Deleted backend/.env and .env.example
- Removed .env entries from both .gitignore files (root and backend)
- Uninstalled dotenv package from backend workspace
- Files changed: backend/src/config.ts, backend/src/lib/db.ts, backend/prisma.config.ts, .gitignore, backend/.gitignore, package-lock.json
- Typecheck passed successfully

**Learnings for future iterations:**
- All backend code now expects environment variables to be exported by the calling script (no dotenv)
- config.ts and db.ts read directly from process.env without any dotenv.config() calls
- prisma.config.ts reads process.env["DATABASE_URL"] directly without dotenv/config import
- This change is foundational - all subsequent scripts must export env vars before running backend code
---
## 2026-02-12 - US-002
- Created scripts/common.sh with ensure_dependencies() function
- Function compares md5 checksum of package-lock.json against stored checksum at node_modules/.package-lock-checksum
- Automatically runs npm install if checksum differs or node_modules is missing
- Cross-platform support: uses `md5 -q` on macOS, `md5sum` on Linux
- File is executable (chmod +x) and can be sourced by other scripts
- Files changed: scripts/common.sh (new file)
- Typecheck passed successfully

**Learnings for future iterations:**
- The ensure_dependencies() function must be sourced before use: `source scripts/common.sh && ensure_dependencies`
- Checksum file is automatically gitignored since it's inside node_modules/
- The function handles both missing node_modules and stale dependencies (changed package-lock.json)
- When calling from other scripts, use: `source "$(dirname "$0")/scripts/common.sh"` or similar to find the file
---
## 2026-02-12 - US-003
- Created run_backend.sh at project root (executable)
- Sources scripts/common.sh and calls ensure_dependencies()
- Runs prisma generate, prisma migrate dev, then npm run dev -w backend
- Expects env vars to be exported by the caller (no dotenv, no .env files)
- Files changed: run_backend.sh (new file)
- Typecheck passed successfully

**Learnings for future iterations:**
- run_backend.sh uses `cd "$(dirname "$0")"` to ensure it runs from project root regardless of caller's cwd
- The script uses `set -e` so any failed step (prisma generate, migrate, etc.) stops execution
- Env vars must be exported before calling this script — it does NOT export them itself
---
## 2026-02-12 - US-004
- Updated start_local_env.sh to be zero-config
- Exports all env vars at the top (DATABASE_URL, JWT_SECRET, PORT, NODE_ENV)
- Sources scripts/common.sh and calls ensure_dependencies() before tmux session creation
- Backend pane now runs ./run_backend.sh instead of separate prisma/npm commands
- Fixed stop() trap to use `docker compose` directly instead of undefined `$local_compose`
- Files changed: start_local_env.sh
- Typecheck passed successfully

**Learnings for future iterations:**
- Env vars exported before tmux session creation are inherited by all panes
- ensure_dependencies() runs before tmux so panes don't race on npm install
- The script uses SCRIPT_DIR + cd to ensure it runs from project root
---
## 2026-02-12 - US-005
- Updated run_test.sh to source scripts/common.sh and call ensure_dependencies()
- Added prisma generate step before running migrations (cd to backend dir, then npx prisma generate)
- Test env vars remain inline as before (DATABASE_URL, JWT_SECRET, PORT, NODE_ENV with test values)
- Also fixed US-003 run_backend.sh: prisma CLI doesn't support -w flag, must cd into backend dir
- Backend tests pass (146/146). E2E tests have a pre-existing blank page rendering issue (not caused by these changes)
- Files changed: run_test.sh, run_backend.sh

**Learnings for future iterations:**
- Prisma CLI (generate, migrate) does NOT support npm workspace -w flag — must cd into the workspace directory
- E2E tests have a pre-existing blank page issue on /register — needs investigation in a separate story
- run_test.sh keeps its own inline test env vars (different DB port 5433, test JWT secret, NODE_ENV=test)
---
