{
  "project": "nSuns 4-Day LP Workout Tracker",
  "branchName": "ralph/multi-plan-part1",
  "description": "Multi-Plan Support Part 1: Database schema, seed data, admin API endpoints, user plan subscription, and core backend refactor to plan-driven workout generation and completion.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Exercise table",
      "description": "As a developer, I need an exercises table to store a library of exercises that plans can reference.",
      "acceptanceCriteria": [
        "Create Prisma migration adding exercises table with columns: id (autoincrement PK), slug (unique string), name (string), muscle_group (nullable string), category (string, default 'compound'), is_upper_body (boolean, default false), created_at (timestamptz)",
        "Schema maps to exercises table name (@@map('exercises'))",
        "Add proper @map() for snake_case column names (muscle_group, is_upper_body, created_at)",
        "Migration runs successfully with npx prisma migrate dev from backend/",
        "npx prisma generate succeeds and app compiles",
        "Existing tests still pass",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create WorkoutPlan and PlanDay tables",
      "description": "As a developer, I need tables to store workout plan metadata and their day structure.",
      "acceptanceCriteria": [
        "Create migration adding workout_plans table: id (autoincrement PK), slug (unique string), name (string), description (nullable string), days_per_week (int), is_public (boolean, default true), is_system (boolean, default false), archived_at (nullable timestamptz), created_at (timestamptz), updated_at (timestamptz with @updatedAt)",
        "Create plan_days table: id (autoincrement PK), plan_id (FK to workout_plans, cascade delete), day_number (int), name (nullable string)",
        "Unique constraint on (plan_id, day_number) in plan_days",
        "All columns use @map() for snake_case names, tables use @@map()",
        "Migration runs successfully from backend/ directory",
        "App compiles and existing tests pass",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create PlanDayExercise and PlanSet tables",
      "description": "As a developer, I need tables to define which exercises go on each plan day and their set schemes.",
      "acceptanceCriteria": [
        "Create plan_day_exercises table: id, plan_day_id (FK to plan_days, cascade), exercise_id (FK to exercises), tier (string), sort_order (int), tm_exercise_id (FK to exercises — which exercise's TM to use), display_name (nullable string)",
        "Unique constraint on (plan_day_id, sort_order)",
        "Exercise relation uses exerciseId FK, tmExercise relation uses tmExerciseId FK with named relation 'tmExerciseRef'",
        "Create plan_sets table: id, plan_day_exercise_id (FK to plan_day_exercises, cascade), set_order (int), percentage (decimal 5,4), reps (int), is_amrap (boolean, default false), is_progression (boolean, default false)",
        "Unique constraint on (plan_day_exercise_id, set_order)",
        "All columns use @map() for snake_case, tables use @@map()",
        "Migration runs, app compiles, existing tests pass",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create PlanProgressionRule and UserPlan tables",
      "description": "As a developer, I need tables for per-plan progression rules and user-plan subscriptions.",
      "acceptanceCriteria": [
        "Create plan_progression_rules table: id, plan_id (FK to workout_plans, cascade), exercise_id (nullable FK to exercises), category (nullable string), min_reps (int), max_reps (int), increase (decimal 5,2 in kg)",
        "Create user_plans table: id, user_id (FK to users), plan_id (FK to workout_plans), is_active (boolean, default true), started_at (timestamptz, default now), ended_at (nullable timestamptz)",
        "Add plans UserPlan[] relation to User model and subscriptions UserPlan[] to WorkoutPlan model",
        "Add progressionRules PlanProgressionRule[] relation to WorkoutPlan model",
        "All columns use @map() for snake_case, tables use @@map()",
        "Migration runs, app compiles, existing tests pass",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Add isAdmin and new FK columns to existing tables",
      "description": "As a developer, I need to add isAdmin to users and nullable FK columns to existing tables for the eventual switchover.",
      "acceptanceCriteria": [
        "Add is_admin (boolean, default false) to users table",
        "Add exercise_id (nullable int, FK to exercises) to training_maxes table, add Exercise relation",
        "Add exercise_id (nullable int, FK to exercises) and is_progression (boolean, default false) to workout_sets table, add Exercise relation",
        "Add plan_day_id (nullable int, FK to plan_days) to workouts table",
        "All new columns are nullable or have defaults so existing code is unaffected",
        "Update all affected model relations (Exercise model needs trainingMaxes and workoutSets arrays)",
        "Migration runs, app compiles, existing tests pass",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Seed exercise library",
      "description": "As a developer, I need to seed the database with common exercises so plans can reference them.",
      "acceptanceCriteria": [
        "Create seed script at backend/prisma/seed.ts that inserts 24 exercises: bench-press, squat, deadlift, ohp, barbell-row, pull-up, close-grip-bench, sumo-deadlift, front-squat, incline-bench, romanian-deadlift, dumbbell-ohp, leg-press, chin-up, dip, pendlay-row, hip-thrust, lateral-raise, bicep-curl, tricep-pushdown, face-pull, leg-curl, leg-extension, calf-raise",
        "Each exercise has correct slug, name, muscleGroup, category (compound/isolation), and isUpperBody values as specified in the plan document",
        "Seed is idempotent — uses upsert on slug so it can run multiple times without duplicates",
        "Add prisma seed config to backend/package.json: { \"prisma\": { \"seed\": \"npx tsx prisma/seed.ts\" } }",
        "Seed runs successfully with npx prisma db seed from backend/",
        "App compiles and tests pass",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Exercise data from plan doc section 11. Key exercises for nSuns: bench-press (chest, compound, upper), squat (legs, compound, lower), deadlift (back, compound, lower), ohp (shoulders, compound, upper), close-grip-bench (chest, compound, upper), sumo-deadlift (back, compound, lower), front-squat (legs, compound, lower)"
    },
    {
      "id": "US-007",
      "title": "Seed nSuns 4-Day LP plan structure",
      "description": "As a developer, I need to seed the nSuns 4-Day LP program as structured plan data including days, exercises, and set schemes.",
      "acceptanceCriteria": [
        "Extend seed script to create WorkoutPlan: slug 'nsuns-4day-lp', name 'nSuns 4-Day LP', daysPerWeek 4, isPublic true, isSystem true",
        "Creates 4 PlanDays with names: 'Bench Volume & OHP', 'Squat & Sumo Deadlift', 'Bench Heavy & Close Grip Bench', 'Deadlift & Front Squat'",
        "Creates PlanDayExercises: Day 1 = Bench T1 (tmExercise=bench-press, display='Bench Volume') + OHP T2 (tmExercise=ohp), Day 2 = Squat T1 (tmExercise=squat) + Sumo Deadlift T2 (tmExercise=deadlift), Day 3 = Bench T1 (tmExercise=bench-press, display='Bench Heavy') + Close Grip Bench T2 (tmExercise=bench-press), Day 4 = Deadlift T1 (tmExercise=deadlift) + Front Squat T2 (tmExercise=squat)",
        "Creates PlanSets with exact percentages from CLAUDE.md: Day 1 T1 = 65/8, 75/6, 85/4, 85/4, 85/4, 80/5, 75/6, 70/7, 65/8+(amrap+progression). Day 2 T1 = 75/5, 85/3, 95/1+(amrap+progression), 90/3, 85/3, 80/3, 75/5, 70/5, 65/5+(amrap). Day 3 T1 = 75/5, 85/3, 95/1+(amrap+progression), 90/3, 85/5, 80/3, 75/5, 70/3, 65/5+(amrap). Day 4 T1 = 75/5, 85/3, 95/1+(amrap+progression), 90/3, 85/3, 80/3, 75/3, 70/3, 65/3+(amrap)",
        "Creates T2 PlanSets: OHP = 50/6,60/5,70/3,70/5,70/7,70/4,70/6,70/8. Sumo DL = 50/5,60/5,70/3,70/5,70/7,70/4,70/6,70/8. CG Bench = 40/6,50/5,60/3,60/5,60/7,60/4,60/6,60/8. Front Squat = 35/5,45/5,55/3,55/5,55/7,55/4,55/6,55/8",
        "Seed is idempotent (upsert on plan slug, delete+recreate days/exercises/sets)",
        "Seed runs after exercises are seeded (exercises must exist first)",
        "npx prisma db seed runs successfully",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Percentages stored as decimals in DB (e.g., 0.6500 for 65%). isProgression marks the set used for TM adjustment — Day 1 it's the last set (65% AMRAP), Days 2-4 it's the 95% set. T2 sets have no progression sets."
    },
    {
      "id": "US-008",
      "title": "Seed nSuns progression rules",
      "description": "As a developer, I need to seed progression rules for the nSuns plan so workout completion can calculate TM increases.",
      "acceptanceCriteria": [
        "Extend seed script to create PlanProgressionRules for the nsuns-4day-lp plan",
        "Upper body rules (category='upper'): 0-1 reps = 0kg increase, 2-3 reps = +2.5kg, 4-5 reps = +2.5kg, 5+ reps = +5kg",
        "Lower body rules (category='lower'): 0-1 reps = 0kg increase, 2-3 reps = +5kg, 4-5 reps = +5kg, 5+ reps = +7.5kg",
        "Rules use minReps/maxReps ranges: (0,1,0), (2,3,2.5)/(2,3,5), (4,5,2.5)/(4,5,5), (6,99,5)/(6,99,7.5) for upper/lower",
        "Seed is idempotent (delete existing rules for plan, re-create)",
        "npx prisma db seed runs successfully",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "0-1 reps rules can be omitted since 0 increase is the default behavior. But including them makes the logic explicit. Use category-level rules, not exercise-specific."
    },
    {
      "id": "US-009",
      "title": "Admin authorization middleware",
      "description": "As a developer, I need middleware that restricts certain endpoints to admin users only.",
      "acceptanceCriteria": [
        "Create requireAdmin middleware in backend/src/middleware/admin.ts that checks isAdmin from JWT payload",
        "Returns 403 { error: { code: 'FORBIDDEN', message: 'Admin access required' } } if user is not admin",
        "Update JWT payload to include isAdmin at login time — read isAdmin from User model when generating token",
        "Update auth middleware to decode and attach isAdmin to the request (extend AuthRequest type)",
        "Include isAdmin in /api/auth/login and /api/auth/register response user object",
        "Existing non-admin routes are unaffected",
        "Write backend tests: non-admin user gets 403 on admin-protected route, admin user passes through",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 9,
      "passes": true,
      "notes": "AuthRequest type in backend/src/types/index.ts needs isAdmin added. JWT sign includes isAdmin from user record. requireAdmin reads req.isAdmin set by authenticate middleware."
    },
    {
      "id": "US-010",
      "title": "Exercise CRUD admin endpoints",
      "description": "As an admin, I want to create, list, update, and delete exercises through API endpoints.",
      "acceptanceCriteria": [
        "POST /api/admin/exercises — creates exercise from { slug, name, muscleGroup?, category?, isUpperBody? }. Returns 201 with created exercise. Returns 409 if slug already exists",
        "GET /api/admin/exercises — lists all exercises ordered by name",
        "PATCH /api/admin/exercises/:id — updates exercise fields. Returns updated exercise. 404 if not found",
        "DELETE /api/admin/exercises/:id — deletes exercise. Returns 204. Returns 409 if exercise is referenced by any PlanDayExercise. 404 if not found",
        "All endpoints protected by authenticate + requireAdmin middleware",
        "Input validation with zod schemas for create and update",
        "Create route file at backend/src/routes/admin/exercises.ts and mount at /api/admin/exercises in app",
        "Write backend tests for all endpoints: create, list, update, delete, plus error cases (409 conflict, 404 not found, 403 non-admin)",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Mount admin routes under /api/admin prefix. Check PlanDayExercise references before allowing delete (both exerciseId and tmExerciseId)."
    },
    {
      "id": "US-011",
      "title": "Plan CRUD admin endpoints — create and list",
      "description": "As an admin, I want to create workout plans with nested structure and list all plans.",
      "acceptanceCriteria": [
        "POST /api/admin/plans — creates plan with nested structure: { slug, name, description?, daysPerWeek, isPublic?, days: [{ dayNumber, name?, exercises: [{ exerciseId, tier, sortOrder, tmExerciseId, displayName?, sets: [{ setOrder, percentage, reps, isAmrap?, isProgression? }] }] }] }. Creates all nested records in a transaction. Returns 201 with full plan structure including days/exercises/sets",
        "GET /api/admin/plans — lists all plans (including archived) with subscriber count. Returns array of plans with subscriberCount field (count of UserPlan records)",
        "Both endpoints protected by authenticate + requireAdmin middleware",
        "Input validation with zod schema for create (validate nested structure)",
        "Create route file at backend/src/routes/admin/plans.ts and mount at /api/admin/plans",
        "Write backend tests for create and list endpoints",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Use prisma transaction for creating plan + days + exercises + sets atomically. Percentage comes as decimal (e.g., 0.95 for 95%)."
    },
    {
      "id": "US-012",
      "title": "Plan CRUD admin endpoints — get, update, and archive",
      "description": "As an admin, I want to view, update, and archive workout plans.",
      "acceptanceCriteria": [
        "GET /api/admin/plans/:id — returns full plan with nested days, exercises (with exercise details), sets, and progression rules. 404 if not found",
        "PUT /api/admin/plans/:id — replaces plan structure. Deletes old days/exercises/sets via cascade, re-creates in transaction. Cannot change slug of isSystem plans. Returns updated plan with full nested structure",
        "DELETE /api/admin/plans/:id — soft deletes by setting archivedAt to now(). Cannot archive isSystem plans (returns 400). Returns 200 with archived plan",
        "All endpoints protected by authenticate + requireAdmin middleware",
        "Input validation with zod schema for update",
        "Add these routes to the existing backend/src/routes/admin/plans.ts file",
        "Write backend tests for get, update, archive, plus error cases (404, 400 for system plan archive)",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Cascade delete on PlanDay handles cleanup of exercises and sets when replacing plan structure. isSystem plans can be updated (content) but not archived or have slug changed."
    },
    {
      "id": "US-013",
      "title": "Progression rules admin endpoint",
      "description": "As an admin, I want to set progression rules for a plan.",
      "acceptanceCriteria": [
        "POST /api/admin/plans/:id/progression-rules — replaces all progression rules for the plan. Accepts { rules: [{ exerciseId?, category?, minReps, maxReps, increase }] }",
        "Deletes existing rules for the plan and inserts new ones in a transaction",
        "Rules can be exercise-specific (exerciseId set) or category-level (category set: 'upper'/'lower')",
        "Validates plan exists (404 if not), validates exerciseId references exist if provided",
        "Protected by authenticate + requireAdmin middleware",
        "Input validation with zod schema",
        "Add route to existing backend/src/routes/admin/plans.ts",
        "Write backend tests for happy path and error cases",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "User plan list and subscribe endpoints",
      "description": "As a user, I want to browse available plans, view my current plan, and subscribe to a plan.",
      "acceptanceCriteria": [
        "GET /api/plans — lists available plans (isPublic=true, archivedAt=null). Returns array with plan name, slug, description, daysPerWeek, and nested days with exercise summaries",
        "GET /api/plans/current — returns user's active plan with full structure (days/exercises/sets). Returns null (200 with null body) if no active plan",
        "GET /api/plans/:id — returns full plan detail with days, exercises, and sets. 404 if not found or not public/not archived",
        "POST /api/plans/:id/subscribe — subscribes user to plan. Deactivates previous active plan (isActive=false, endedAt=now). Creates new UserPlan row. Returns { userPlan, requiredExercises, missingTMs } where missingTMs lists exercises needing 1RM setup",
        "Only one active plan per user enforced in subscribe logic",
        "All endpoints require JWT auth (not admin)",
        "Create route file at backend/src/routes/plans.ts and mount at /api/plans",
        "Write backend tests for all endpoints",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 14,
      "passes": true,
      "notes": "missingTMs = plan's required TM exercises minus user's existing TrainingMax records. requiredExercises = unique tmExerciseId exercises from the plan. Route ordering matters: /current must be before /:id to avoid 'current' being parsed as an id."
    },
    {
      "id": "US-015",
      "title": "Refactor training max service for exercise IDs",
      "description": "As a developer, I need the training max service to work with exercise IDs alongside the existing string-based system.",
      "acceptanceCriteria": [
        "POST /api/training-maxes/setup accepts new format: { exerciseTMs: [{ exerciseId, oneRepMax }] } in addition to old format { oneRepMaxes: { bench, squat, ohp, deadlift } }",
        "When using new format, creates TrainingMax rows with both exercise string (looked up from exercises table slug) and exercise_id FK",
        "GET /api/training-maxes — when user has an active plan, returns TMs for the plan's required TM exercises (unique tmExerciseIds from plan). Falls back to old behavior (4 hardcoded exercises) if no active plan",
        "Training max rows created going forward populate both exercise (string) and exercise_id (FK) columns",
        "Existing tests still pass unchanged",
        "Write new tests for the exerciseTMs format and plan-aware GET",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Keep backward compat: old format { oneRepMaxes: {...} } still works. Use zod discriminated union or conditional validation. Look up exercise slug from exercises table when creating TM rows with new format."
    },
    {
      "id": "US-016",
      "title": "Refactor workout generation to use plan data",
      "description": "As a developer, I need startWorkout to generate sets from the user's active plan instead of hardcoded NSUNS_4DAY array.",
      "acceptanceCriteria": [
        "POST /api/workouts { dayNumber } — looks up user's active plan (from UserPlan where isActive=true), finds PlanDay for that dayNumber, loads PlanDayExercises with PlanSets",
        "Collects unique tmExerciseIds from the plan day, fetches user's current TMs for those exercises (by exercise_id or exercise slug)",
        "For each PlanDayExercise + PlanSet: calculates weight = roundWeight(tm * percentage), creates WorkoutSet with exerciseId, exercise (slug for backward compat), tier, setOrder, prescribedWeight, prescribedReps, isAmrap, isProgression",
        "Validates dayNumber against plan's daysPerWeek (not hardcoded max 4)",
        "Creates Workout row with planDayId set",
        "Falls back to old hardcoded NSUNS_4DAY logic if user has no active plan (backward compatibility)",
        "Existing tests still pass (use fallback path)",
        "Write new tests for plan-driven workout generation (create test user, subscribe to plan, set TMs, start workout)",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Refactor workout completion to use isProgression and plan rules",
      "description": "As a developer, I need completeWorkout to use the isProgression flag and plan's progression rules instead of hardcoded nSuns logic.",
      "acceptanceCriteria": [
        "POST /api/workouts/:id/complete — finds workout sets where isProgression=true (may be multiple per workout)",
        "For each progression set with actualReps: looks up the exercise (via exerciseId), finds the plan's progression rules (exercise-specific rule first, then category fallback based on exercise's isUpperBody), determines TM increase from matching rule",
        "If increase > 0, inserts new TrainingMax row with both exercise string and exerciseId",
        "Returns progression results as array: { progressions: [{ exercise, previousTM, newTM, increase }] } (note: plural 'progressions' key with array value)",
        "Falls back to old hardcoded logic if workout has no planDayId (backward compatibility for workouts created before plan system)",
        "Existing tests still pass (use fallback path for workouts without planDayId)",
        "Write new tests for plan-driven completion: create workout via plan, log AMRAP reps, complete, verify TM increases match plan rules",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Look up plan via workout's planDayId -> planDay -> plan -> progressionRules. Match rule: find rule where exerciseId matches (specific), or category matches exercise's isUpperBody ('upper'/'lower'), and actualReps is between minReps and maxReps."
    }
  ]
}
