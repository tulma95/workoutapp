# Ralph Progress Log
---
## Codebase Patterns
- Environment variables are exported by shell scripts, never loaded from .env files
- All scripts source scripts/common.sh for shared helpers (ensure_dependencies)
- Backend reads process.env directly without dotenv
- prisma.config.ts reads process.env["DATABASE_URL"] without dotenv/config import
- Checksum of package-lock.json stored at node_modules/.package-lock-checksum to detect stale dependencies
- Prisma CLI does NOT support npm workspace `-w` flag — must `cd backend` then run `npx prisma generate` / `npx prisma migrate dev`
- Use controlled components for complex stateful UI elements to avoid state reset issues
- Show loading overlays instead of unmounting components during async operations
- View Transition API requires TypeScript type declarations in vite-env.d.ts
- Use document.startViewTransition() with feature detection for smooth animations
- Prisma v7 uses prisma-client generator (not prisma-client-js), no url in schema.prisma datasource, connection URL in prisma.config.ts
- Requires @prisma/adapter-pg adapter: new PrismaClient({ adapter: new PrismaPg({ connectionString }) })
- Client generated to backend/src/generated/prisma/ (gitignored)
- Export DATABASE_URL before running Prisma CLI commands (docker compose up -d required before migrations)
---

## 2026-02-13 07:30 UTC - US-001
- Implemented Exercise table in Prisma schema
- Created migration `20260213072742_add_exercises_table`
- Files changed: backend/prisma/schema.prisma, backend/prisma/migrations/20260213072742_add_exercises_table/migration.sql
- **Learnings for future iterations:**
  - Exercise model was already in schema.prisma but migration didn't exist yet
  - Must start docker compose before running migrations (docker compose up -d --wait)
  - Must export DATABASE_URL environment variable before running prisma commands
  - Backend doesn't have a typecheck script, use `npm run build -w backend` instead
  - Generated Prisma client is gitignored, only schema and migrations are committed
  - All 153 tests passed after migration
---

## 2026-02-13 07:35 UTC - US-002
- Implemented WorkoutPlan and PlanDay tables in Prisma schema
- Created migration `20260213073015_add_workout_plans_and_plan_days`
- Files changed: backend/prisma/schema.prisma, backend/prisma/migrations/20260213073015_add_workout_plans_and_plan_days/migration.sql
- **Learnings for future iterations:**
  - WorkoutPlan has unique slug constraint for plan identification
  - PlanDay uses composite unique constraint (planId, dayNumber) to prevent duplicate day numbers per plan
  - Cascade delete ensures plan_days are removed when workout_plan is deleted
  - All backend tests (153) and E2E tests (27 passed, 6 skipped) still passing
---
## 2026-02-13 07:34 UTC - US-004
- Implemented PlanProgressionRule and UserPlan tables in Prisma schema
- Created migration `20260213073422_add_plan_progression_rules_and_user_plans`
- Files changed: backend/prisma/schema.prisma, backend/prisma/migrations/20260213073422_add_plan_progression_rules_and_user_plans/migration.sql, scripts/ralph/CLAUDE.md
- **Learnings for future iterations:**
  - PlanProgressionRule supports both exercise-specific (exerciseId set) and category-based (category='upper'/'lower') progression rules
  - UserPlan tracks user subscriptions to plans with isActive flag and started_at/ended_at timestamps for history
  - Added bidirectional relations: WorkoutPlan has progressionRules and subscriptions arrays, User has plans array, Exercise has progressionRules array
  - Migration cascade deletes: when WorkoutPlan is deleted, its progression rules and user subscriptions are also deleted
  - All 153 backend tests + 27 E2E tests still passing after schema changes
---
## 2026-02-13 07:37 UTC - US-005
- Added isAdmin and new FK columns to existing tables
- Created migration `20260213073740_add_admin_and_fk_columns`
- Files changed: backend/prisma/schema.prisma, backend/prisma/migrations/20260213073740_add_admin_and_fk_columns/migration.sql
- **Learnings for future iterations:**
  - Added is_admin column to users table for admin authorization (default false)
  - Added exercise_id FK to training_maxes table for plan-based training max management (nullable for backward compatibility)
  - Added exercise_id FK and is_progression flag to workout_sets table (both nullable/default for backward compatibility)
  - Added plan_day_id FK to workouts table to link workouts to plan structure (nullable for backward compatibility)
  - All new columns are nullable or have defaults to ensure existing code continues to work
  - Updated Prisma relations: Exercise model now has trainingMaxes and workoutSets arrays, PlanDay has workouts array
  - All 153 backend tests still passing after schema changes
---
## 2026-02-13 09:45 UTC - US-006
- Implemented exercise library seed script
- Created backend/prisma/seed.ts with 24 exercises using idempotent upsert logic
- Added seed configuration to prisma.config.ts (migrations.seed field)
- Files changed: backend/prisma/seed.ts, backend/prisma.config.ts
- **Learnings for future iterations:**
  - Prisma v7 requires seed config in prisma.config.ts (migrations.seed field), not package.json
  - Seed script must import from '../src/generated/prisma/client' not '@prisma/client'
  - Use PrismaPg adapter with connectionString directly, not Pool (matches existing db.ts pattern)
  - Seed script needs DATABASE_URL env var exported before running
  - All 153 backend tests + 27 E2E tests passing after seed implementation
---

## 2026-02-13 09:50 UTC - US-007
- Implemented nSuns 4-Day LP plan structure in seed script
- Created WorkoutPlan with slug 'nsuns-4day-lp', 4 days per week, system plan
- Created 4 PlanDays with correct names
- Created 8 PlanDayExercises (2 per day: T1 and T2)
  - Day 1: Bench Volume (T1) + OHP (T2)
  - Day 2: Squat (T1) + Sumo Deadlift (T2)
  - Day 3: Bench Heavy (T1) + Close Grip Bench (T2)
  - Day 4: Deadlift (T1) + Front Squat (T2)
- Created all PlanSets with exact percentages matching CLAUDE.md spec
  - T1 sets: 9 sets each (Day 1: 65% final AMRAP as progression, Days 2-4: 95% AMRAP as progression)
  - T2 sets: 8 sets each (no progression sets)
- Files changed: backend/prisma/seed.ts
- **Learnings for future iterations:**
  - Seed is idempotent: uses upsert on plan slug, then deletes and recreates days/exercises/sets via cascade
  - Percentages stored as decimals (e.g., 0.6500 for 65%)
  - isProgression flag marks the set used for TM adjustment (highest % AMRAP per T1 exercise)
  - tmExerciseId determines which TM to use for weight calculation (e.g., Close Grip Bench uses bench-press TM)
  - displayName allows same exercise to appear with different labels (Bench Volume vs Bench Heavy)
  - All 153 backend tests + 27 E2E tests passing after implementation
---

## 2026-02-13 09:52 UTC - US-008
- Implemented nSuns progression rules in seed script
- Created 8 progression rules for the nSuns plan (4 upper body, 4 lower body)
- Upper body rules (category='upper'): 0-1→0kg, 2-3→+2.5kg, 4-5→+2.5kg, 6+→+5kg
- Lower body rules (category='lower'): 0-1→0kg, 2-3→+5kg, 4-5→+5kg, 6+→+7.5kg
- Seed is idempotent (deletes existing rules for plan before re-creating)
- Files changed: backend/prisma/seed.ts
- **Learnings for future iterations:**
  - Progression rules use minReps/maxReps ranges to match actual AMRAP reps to TM increases
  - Category-based rules apply to all exercises in that category (upper/lower body)
  - Exercise-specific rules can override category rules (exerciseId set instead of category)
  - Including 0-1→0kg rule makes the "no increase" behavior explicit rather than implicit
  - All 153 backend tests + 27 E2E tests passing after implementation
---
## 2026-02-13 10:00 UTC - US-010
- Implemented Exercise CRUD admin endpoints
- Created /api/admin/exercises route with POST, GET, PATCH, DELETE handlers
- All endpoints protected by authenticate + requireAdmin middleware
- POST creates exercise, returns 409 on duplicate slug
- GET lists exercises ordered by name
- PATCH updates exercise, returns 404 if not found
- DELETE checks for PlanDayExercise references (both exerciseId and tmExerciseId), returns 409 if referenced
- Files changed: 
  - backend/src/routes/admin/exercises.ts (new)
  - backend/src/__tests__/routes/admin/exercises.test.ts (new)
  - backend/src/app.ts (mounted admin routes)
  - backend/src/__tests__/setup.ts (added new tables to truncate)
- **Learnings for future iterations:**
  - Admin routes follow pattern: authenticate + requireAdmin middleware at router level
  - Express req.params.id is typed as string | string[], needs explicit cast to string for parseInt
  - Test setup must truncate ALL tables including newly added ones to avoid constraint violations
  - When testing delete constraints, create test data in the test rather than relying on seed data (which gets truncated)
  - Zod validation schemas use .optional() for nullable/optional fields
  - Prisma error codes: P2002 = unique constraint violation, P2025 = record not found
  - All 171 backend tests passing after implementation
---
## 2026-02-13 10:05 UTC - US-011
- Implemented Plan CRUD admin endpoints for create and list operations
- Created POST /api/admin/plans endpoint that creates plans with full nested structure (days, exercises, sets) in a single transaction
- Created GET /api/admin/plans endpoint that lists all plans with subscriber counts
- Both endpoints protected by authenticate + requireAdmin middleware
- Input validation with zod for nested plan structure (nested objects: days -> exercises -> sets)
- Files changed:
  - backend/src/routes/admin/plans.ts (new)
  - backend/src/__tests__/routes/admin/plans.test.ts (new)
  - backend/src/app.ts (mounted /api/admin/plans route)
- **Learnings for future iterations:**
  - Prisma transactions are used for atomic creation of nested data (plan + days + exercises + sets)
  - GET endpoint returns subscriber count by including subscriptions relation and mapping to count
  - Percentage decimals are stored as Decimal(5,4) in DB (e.g., 0.7500), returned as strings in JSON (e.g., "0.75")
  - When comparing decimal percentages in tests, use parseFloat() and toBeCloseTo() instead of exact string equality
  - Test data setup: use slug-based lookups instead of assuming IDs when tests may run in different order
  - Plan structure: WorkoutPlan -> PlanDay -> PlanDayExercise -> PlanSet (4 levels deep)
  - All 178 backend tests + 27 E2E tests passing after implementation
---
## 2026-02-13 10:10 UTC - US-012
- Implemented Plan CRUD admin endpoints for get, update, and archive operations
- Added GET /api/admin/plans/:id endpoint that returns full plan with nested days, exercises (with exercise details), sets, and progression rules
- Added PUT /api/admin/plans/:id endpoint that replaces plan structure in a transaction (deletes old days/exercises/sets via cascade, creates new ones)
- Added DELETE /api/admin/plans/:id endpoint that soft-deletes plans by setting archivedAt timestamp
- Implemented validation: cannot archive system plans, cannot change slug of system plans
- Added comprehensive tests for all endpoints including error cases (404, 400 for system plan operations)
- Files changed:
  - backend/src/routes/admin/plans.ts (added 3 endpoints: GET /:id, PUT /:id, DELETE /:id)
  - backend/src/__tests__/routes/admin/plans.test.ts (added 4 test suites with 13 test cases)
- **Learnings for future iterations:**
  - PUT endpoint uses cascade delete pattern: deleting PlanDay records automatically deletes related PlanDayExercise and PlanSet records
  - System plans have special protection: can be updated (content) but cannot be archived or have slug changed
  - GET /:id endpoint includes full nested structure with exercise details (via exercise and tmExercise relations)
  - Soft delete pattern: set archivedAt timestamp instead of hard delete to preserve data integrity
  - Express req.params.id requires explicit cast to string before parseInt for TypeScript type safety
  - All 191 backend tests + 27 E2E tests passing after implementation
---
## 2026-02-13 10:15 UTC - US-013
- Implemented POST /api/admin/plans/:id/progression-rules endpoint
- Endpoint replaces all progression rules for a plan in a single transaction
- Supports both exercise-specific rules (exerciseId) and category-based rules (category='upper'/'lower')
- Added comprehensive tests covering happy path and error cases (8 test cases total)
- Files changed:
  - backend/src/routes/admin/plans.ts (added progressionRuleSchema, setProgressionRulesSchema, and POST /:id/progression-rules route)
  - backend/src/__tests__/routes/admin/plans.test.ts (added describe block with 8 test cases)
- **Learnings for future iterations:**
  - When validating array of IDs that may contain duplicates, deduplicate before checking count (e.g., rules can reference the same exerciseId multiple times for different rep ranges)
  - Use type predicate in filter for proper TypeScript type narrowing: `.filter((id: number | undefined): id is number => id !== undefined)`
  - Explicitly type the result when using Array.from(new Set()): `const uniqueIds: number[] = Array.from(new Set(ids))`
  - Transaction pattern for replace operation: delete all existing records, then create new ones
  - All 198 backend tests + 27 E2E tests passing after implementation
---
## 2026-02-13 10:20 UTC - US-014
- Implemented User plan list and subscribe endpoints
- Created /api/plans route with 4 endpoints: GET /, GET /current, GET /:id, POST /:id/subscribe
- All endpoints protected by JWT authentication (not admin)
- GET /api/plans lists all public, non-archived plans with full nested structure (days -> exercises -> sets)
- GET /api/plans/current returns user's active plan or null if none exists
- GET /api/plans/:id returns plan detail with full structure (404 for archived/private plans)
- POST /api/plans/:id/subscribe subscribes user to plan, deactivates previous active plan, returns userPlan, requiredExercises, and missingTMs
- Comprehensive test coverage with 18 test cases covering happy paths and error scenarios
- Files changed:
  - backend/src/routes/plans.ts (new, 230 lines)
  - backend/src/__tests__/routes/plans.test.ts (new, 430 lines)
  - backend/src/app.ts (mounted /api/plans route)
- **Learnings for future iterations:**
  - Route ordering matters: /current must be before /:id to avoid 'current' being parsed as an id parameter
  - req.userId is potentially undefined in TypeScript, use req.userId! when middleware guarantees it's defined
  - Subscribe logic deactivates old plans with updateMany, then creates new subscription in a transaction
  - missingTMs calculation: get all unique tmExerciseIds from plan, fetch user's existing TMs by exerciseId, subtract to find missing ones
  - requiredExercises includes all exercises needed for TMs (unique tmExerciseId values from plan)
  - All 216 backend tests + 27 E2E tests passing after implementation
---
## 2026-02-13 10:30 UTC - US-015
- Implemented exercise ID support for training max service
- Added POST /api/training-maxes/setup support for new format: { exerciseTMs: [{ exerciseId, oneRepMax }] }
- New format creates TrainingMax rows with both exercise string (slug) and exercise_id FK
- GET /api/training-maxes now returns plan-aware TMs when user has active plan
- Falls back to hardcoded exercises when no active plan, with deduplication to handle both old short names and new slugs
- Files changed:
  - backend/src/services/trainingMax.service.ts (added setupFromExerciseTMs function, updated getCurrentTMs to be plan-aware)
  - backend/src/routes/trainingMaxes.ts (updated setup endpoint to handle both formats with zod union)
  - backend/src/__tests__/trainingMaxes.test.ts (added comprehensive tests for new format and plan-aware behavior)
  - backend/src/__tests__/setup.ts (seeded core exercises in test setup for consistent test data)
- **Learnings for future iterations:**
  - Zod union types work well for backward-compatible API changes (old vs new format)
  - Type predicates are needed when filtering arrays: `.filter((tm): tm is NonNullable<typeof tm> => ...)`
  - When supporting both old short names (bench) and new slugs (bench-press), need deduplication to avoid returning duplicates
  - Plan-aware queries: fetch user's active plan with nested relations, extract unique tmExerciseIds from plan days
  - Test setup can seed common test data in global beforeAll to avoid duplication across test files
  - All 222 backend tests + 27 E2E tests passing
---
## 2026-02-13 10:35 UTC - US-016
- Implemented plan-driven workout generation in startWorkout service
- Updated POST /api/workouts to check for active plan and generate sets from plan structure
- Loads PlanDay with nested PlanDayExercises and PlanSets, generates WorkoutSet records with exerciseId, isProgression populated
- Validates dayNumber dynamically against plan's daysPerWeek instead of hardcoded max 4
- Sets planDayId on Workout record to link to plan structure
- Falls back to hardcoded NSUNS_4DAY logic for users without active plan (backward compatibility)
- Files changed:
  - backend/src/services/workout.service.ts (refactored startWorkout function with plan-driven logic)
  - backend/src/routes/workouts.ts (removed hardcoded max(4) validation from schema)
  - backend/src/__tests__/workouts-plan-driven.test.ts (new comprehensive test suite)
- **Learnings for future iterations:**
  - When filtering query results with WHERE conditions, validate input BEFORE using it in the WHERE clause to get proper error messages
  - Load plan metadata first (without nested days), validate dayNumber against daysPerWeek, THEN fetch the specific day to avoid empty results
  - Test setup: create minimal plan structure needed for tests rather than relying on seed data (seed doesn't run in test DB)
  - Use upsert for test fixtures to make tests idempotent and avoid constraint violations
  - Backward compatibility: check for activePlan existence, then branch to new logic vs fallback logic
  - All 228 backend tests + 27 E2E tests passing after implementation
---
## 2026-02-13 10:40 UTC - US-017
- Implemented plan-driven workout completion with isProgression flag and progression rules
- Updated completeWorkout service to find progression sets using isProgression=true
- For each progression set: looks up exercise, finds matching progression rule (exercise-specific first, then category fallback), calculates TM increase
- Creates new TrainingMax rows with both exercise string (slug) and exerciseId FK
- Returns progressions array (plural) instead of single progression object for plan-driven workouts
- Maintains backward compatibility: workouts without planDayId use old hardcoded nSuns logic and return single progression object
- Files changed:
  - backend/src/services/workout.service.ts (refactored completeWorkout function with plan-driven logic)
  - backend/src/__tests__/workoutCompletion-plan-driven.test.ts (new comprehensive test suite with 5 test cases)
- **Learnings for future iterations:**
  - Plan-driven completion supports multiple progression sets per workout (e.g., both T1 and T2 can have progression)
  - Progression rule matching: exercise-specific rule takes precedence over category-based rule ('upper'/'lower')
  - Category is determined by exercise.isUpperBody: true = 'upper', false = 'lower'
  - TM rows created with both exercise slug (for backward compat) and exerciseId (for plan system)
  - Response format differs: plan-driven returns { progressions: [...] }, fallback returns { progression: {...} or null }
  - Test expectations must account for weight rounding: 140 * 0.9 = 126 rounds to 125 (nearest 2.5kg)
  - All 234 backend tests + 27 E2E tests passing after implementation
---
