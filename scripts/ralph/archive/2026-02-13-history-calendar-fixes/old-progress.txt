# Ralph Progress Log
---
## Codebase Patterns
- Environment variables are exported by shell scripts, never loaded from .env files
- All scripts source scripts/common.sh for shared helpers (ensure_dependencies)
- Backend reads process.env directly without dotenv
- prisma.config.ts reads process.env["DATABASE_URL"] without dotenv/config import
- Checksum of package-lock.json stored at node_modules/.package-lock-checksum to detect stale dependencies
- Prisma CLI does NOT support npm workspace `-w` flag â€” must `cd backend` then run `npx prisma generate` / `npx prisma migrate dev`
- Use controlled components for complex stateful UI elements to avoid state reset issues
- Show loading overlays instead of unmounting components during async operations
- View Transition API requires TypeScript type declarations in vite-env.d.ts
- Use document.startViewTransition() with feature detection for smooth animations
---

## 2026-02-12 - US-001
- Fixed calendar month navigation by making WorkoutCalendar a controlled component
- WorkoutCalendar now accepts year and month as props instead of using internal useState
- HistoryPage now keeps the calendar rendered during loading with a visual loading overlay
- Removed conditional rendering that was causing the calendar to unmount and reset
- Files changed:
  - `frontend/src/components/WorkoutCalendar.tsx` - Removed internal state, added year/month/isLoading props, disabled nav buttons during loading
  - `frontend/src/components/WorkoutCalendar.css` - Added loading state styles (opacity, overlay, disabled button styles)
  - `frontend/src/pages/HistoryPage.tsx` - Removed conditional rendering, always render calendar with isLoading prop
- **Learnings for future iterations:**
  - Controlled components prevent state reset issues when parent conditionally renders children
  - Keep components mounted and use visual loading states instead of unmounting during loading
  - When components remount, useState initializers run again, resetting state to initial values
  - Loading overlays (reduced opacity + pointer-events: none) are better UX than completely hiding content
---

## 2026-02-12 - US-002
- Added View Transition API animations for smooth month navigation
- Implemented directional sliding animations (prev/next) with feature detection fallback
- Files changed:
  - `frontend/src/vite-env.d.ts` - Added TypeScript types for View Transition API (ViewTransition, Document.startViewTransition)
  - `frontend/src/components/WorkoutCalendar.tsx` - Added transitionDirection state, updated onMonthChange to pass direction, added data-transition-direction attribute to grid
  - `frontend/src/components/WorkoutCalendar.css` - Added view-transition-name to grid, keyframe animations for slide left/right, @supports check for graceful degradation
  - `frontend/src/pages/HistoryPage.tsx` - Wrapped state updates in document.startViewTransition() with feature detection
- **Learnings for future iterations:**
  - View Transition API requires TypeScript type declarations since it's relatively new (Chrome 111+, Safari 18+, Firefox 132+)
  - Use document.startViewTransition(() => { /* state updates */ }) pattern to animate DOM changes
  - Set view-transition-name on CSS elements to target them in ::view-transition-old/new pseudo-elements
  - Use data attributes or classes to pass directional information to CSS for different animation directions
  - Always wrap in feature detection: if (document.startViewTransition) for graceful degradation
  - Animation duration 150-250ms provides snappy, polished feel without feeling sluggish
---

## 2026-02-12 - US-003
- Enabled parallel execution for Playwright E2E tests
- Replaced Date.now() with crypto.randomUUID() for unique test user generation
- Test suite now completes in ~9s instead of ~28s (3x faster)
- Files changed:
  - `playwright.config.ts` - Set fullyParallel: true, changed workers from 1 to 4 (2 in CI)
  - `e2e/fixtures.ts` - Replaced Date.now() timestamp with crypto.randomUUID() to prevent email collisions
- **Learnings for future iterations:**
  - Parallel tests require truly unique identifiers - Date.now() can collide when tests start simultaneously
  - crypto.randomUUID() provides guaranteed uniqueness across parallel test workers
  - Each test fixture creates its own isolated user with its own data, so DB isolation is automatic
  - Setting workers: 4 provides good parallelism on dev machines, workers: 2 is safer for CI
  - All 27 E2E tests pass without flakiness when run in parallel
---

## 2026-02-12 - US-004
- Created zod schemas for frontend API workout response types
- Replaced TypeScript interfaces with z.infer<> types derived from schemas
- Files changed:
  - `frontend/src/api/schemas.ts` - New file with zod schemas for WorkoutSet, Workout, WorkoutHistoryItem, CalendarWorkout, ProgressionResult, CompleteWorkoutResponse
  - `frontend/src/api/workouts.ts` - Removed interface declarations, now imports types from schemas.ts
  - `package-lock.json` - Updated after npm install (zod was already installed)
- **Learnings for future iterations:**
  - Zod schemas provide runtime validation and type safety from a single source of truth
  - Use z.infer<typeof Schema> to derive TypeScript types from zod schemas
  - Export both schemas and types from the schemas file for reuse
  - Schemas can be used later for .parse() validation at runtime (US-006)
  - Status enum uses z.enum(['in_progress', 'completed', 'discarded']) for type-safe literals
---

## 2026-02-12 - US-005
- Added zod schemas for auth and training max API response types
- Completed frontend runtime validation coverage for all API responses
- Files changed:
  - `frontend/src/api/schemas.ts` - Added User, LoginResponse, TrainingMax, OneRepMaxes, SetupResponse, TrainingMaxHistory schemas
  - `frontend/src/api/auth.ts` - Exports User and LoginResponse types from schemas
  - `frontend/src/api/trainingMaxes.ts` - Removed interface declarations, now imports types from schemas
  - `frontend/src/context/AuthContext.tsx` - Imports User type from schemas instead of defining locally
- **Learnings for future iterations:**
  - Consolidate all zod schemas in a single schemas.ts file for easy maintenance
  - Re-export types from API modules (auth.ts, workouts.ts, etc.) to preserve existing import paths
  - Auth responses include: token + user object with unitPreference
  - Training max responses are arrays of TrainingMax objects
  - SetupResponse and TrainingMaxHistory are array types (not objects)
---

## 2026-02-12 - US-006
- Wired zod validation into all frontend API functions for runtime safety
- All API responses are now validated at runtime, catching mismatches immediately
- Fixed LoginResponseSchema to include accessToken and refreshToken (not just token)
- Files changed:
  - `frontend/src/api/schemas.ts` - Fixed LoginResponseSchema to match actual backend response
  - `frontend/src/api/workouts.ts` - All functions now call schema.parse() on responses
  - `frontend/src/api/auth.ts` - login() and register() parse LoginResponseSchema
  - `frontend/src/api/trainingMaxes.ts` - All functions parse appropriate schemas
- **Learnings for future iterations:**
  - Use schema.parse(data) to validate AND get type-safe data in one call
  - E2E tests verify schemas match actual backend responses - if tests fail, check schema shape
  - Auth responses use accessToken/refreshToken, not token
  - Arrays need .map(item => schema.parse(item)) for validation
  - Null responses need special handling: `data === null ? null : schema.parse(data)`
  - Zod throws descriptive ZodError on validation failure, preventing bad data from propagating
---

## 2026-02-12 - US-007
- Updated E2E month navigation test to verify actual month name changes
- Test now checks month header displays correct month/year after navigation clicks
- Verifies year boundary crossing (e.g., January 2026 to December 2025)
- Files changed:
  - `e2e/history.spec.ts` - Enhanced test to verify month header changes, not just button clicks
- **Learnings for future iterations:**
  - E2E tests should verify actual data changes, not just that UI doesn't crash
  - Use CSS class selectors (.workout-calendar__title) to avoid ambiguity when multiple headings exist
  - Wait for View Transition animations (300ms) before asserting new state
  - Calculate expected months accounting for year boundaries: currentMonth === 0 ? 11 : currentMonth - 1
  - Verify calendar grid remains visible after navigation to ensure full re-render
---
