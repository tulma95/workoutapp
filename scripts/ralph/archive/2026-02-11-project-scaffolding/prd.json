{
  "project": "nSuns 4-Day LP Workout Tracker",
  "branchName": "ralph/database-schema",
  "description": "Database Schema - Replace knex with Prisma ORM, define all 4 data models, run migrations",
  "userStories": [
    {
      "id": "US-001",
      "title": "Replace knex with Prisma and update health check",
      "description": "As a developer, I want Prisma configured as the ORM so that I can define type-safe models and run database queries with generated types.",
      "acceptanceCriteria": [
        "prisma is installed as a devDependency and @prisma/client as a dependency in backend/package.json",
        "knex and pg are removed from backend/package.json dependencies",
        "backend/prisma/schema.prisma exists with: datasource db { provider = 'postgresql', url = env('DATABASE_URL') } and generator client { provider = 'prisma-client-js' }",
        "backend/src/lib/db.ts exports a singleton PrismaClient instance (import { PrismaClient } from '@prisma/client') instead of knex",
        "Health check in backend/src/app.ts uses prisma.$queryRaw or prisma.$queryRawUnsafe('SELECT 1') instead of knex.raw('SELECT 1')",
        "backend/src/__tests__/health.test.ts is updated to mock the PrismaClient instead of knex (mock db.ts to return an object with $queryRaw method)",
        "npm test -w backend passes (health check test works with PrismaClient mock)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Run npx prisma generate after creating schema.prisma so the @prisma/client types are available. The health check test currently mocks knex - update the mock to match PrismaClient's API. Check app.ts for how db is imported and used. Run npx prisma init --datasource-provider postgresql in backend/ to scaffold the schema file."
    },
    {
      "id": "US-002",
      "title": "Add all 4 Prisma models to schema",
      "description": "As a developer, I need User, TrainingMax, Workout, and WorkoutSet models defined in the Prisma schema so that the database structure matches the application design.",
      "acceptanceCriteria": [
        "User model in schema.prisma: id (Int @id @default(autoincrement())), email (String @unique), passwordHash (String @map('password_hash')), displayName (String @map('display_name')), unitPreference (String @default('kg') @map('unit_preference')), createdAt (DateTime @default(now()) @map('created_at')), updatedAt (DateTime @updatedAt @map('updated_at')), with @@map('users')",
        "User model has relation fields: trainingMaxes TrainingMax[], workouts Workout[]",
        "TrainingMax model in schema.prisma: id (Int @id @default(autoincrement())), userId (Int @map('user_id')), exercise (String), weight (Decimal @db.Decimal(6,2)), effectiveDate (DateTime @default(now()) @map('effective_date') @db.Date), createdAt (DateTime @default(now()) @map('created_at')), with @@unique([userId, exercise, effectiveDate]) and @@map('training_maxes')",
        "TrainingMax model has relation: user User @relation(fields: [userId], references: [id])",
        "Workout model in schema.prisma: id (Int @id @default(autoincrement())), userId (Int @map('user_id')), dayNumber (Int @map('day_number')), status (String @default('in_progress')), completedAt (DateTime? @map('completed_at')), createdAt (DateTime @default(now()) @map('created_at')), with @@map('workouts')",
        "Workout model has relations: user User @relation(fields: [userId], references: [id]), sets WorkoutSet[]",
        "WorkoutSet model in schema.prisma: id (Int @id @default(autoincrement())), workoutId (Int @map('workout_id')), exercise (String), tier (String), setOrder (Int @map('set_order')), prescribedWeight (Decimal @db.Decimal(6,2) @map('prescribed_weight')), prescribedReps (Int @map('prescribed_reps')), isAmrap (Boolean @default(false) @map('is_amrap')), actualReps (Int? @map('actual_reps')), completed (Boolean @default(false)), createdAt (DateTime @default(now()) @map('created_at')), with @@map('workout_sets')",
        "WorkoutSet model has: relation workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade), index @@index([workoutId, tier, setOrder])",
        "npx prisma generate -w backend runs without errors (Prisma client generated)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "All 4 models go in the same schema.prisma file. Models have cross-references via relations so they must all be defined together. Use @map for snake_case column names and @@map for snake_case table names. effectiveDate uses @db.Date for PostgreSQL DATE type. Run npx prisma generate after adding models to regenerate the client types."
    },
    {
      "id": "US-003",
      "title": "Run Prisma migration and verify database tables",
      "description": "As a developer, I want the database migration applied so that all tables exist in PostgreSQL with correct constraints and indexes.",
      "acceptanceCriteria": [
        "npx prisma migrate dev --name init runs successfully in the backend workspace and creates a migration file under backend/prisma/migrations/",
        "All 4 tables exist in PostgreSQL: users, training_maxes, workouts, workout_sets",
        "users table has a unique constraint on email column",
        "training_maxes table has a unique constraint on (user_id, exercise, effective_date)",
        "workout_sets table has a foreign key to workouts with ON DELETE CASCADE",
        "workout_sets table has an index on (workout_id, tier, set_order)",
        "npm test -w backend passes (health check test still works)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Docker must be running with PostgreSQL on port 5432 before running the migration. Run: docker compose up -d first if needed. The migration command is: npx prisma migrate dev --name init. You can verify tables by running: npx prisma db execute --stdin <<< 'SELECT table_name FROM information_schema.tables WHERE table_schema = '\\''public'\\'''. Or use npx prisma studio to visually inspect."
    }
  ]
}
