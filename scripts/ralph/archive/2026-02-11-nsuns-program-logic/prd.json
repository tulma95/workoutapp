{
  "project": "nSuns 4-Day LP Workout Tracker",
  "branchName": "ralph/nsuns-program-logic",
  "description": "nSuns 4-Day Program Logic - Pure domain logic for program definition, weight rounding, progression calculation, and workout set generation",
  "userStories": [
    {
      "id": "US-012",
      "title": "Implement weight rounding",
      "description": "As a developer, I need a weight rounding function so that calculated weights snap to real plate increments (2.5kg or 5lb).",
      "acceptanceCriteria": [
        "lib/weightRounding.ts exports roundWeight(weight: number, unit: 'kg' | 'lb'): number",
        "For 'kg': rounds to nearest 2.5 (e.g. 63.7 → 65, 61.2 → 62.5, 62.5 → 62.5)",
        "For 'lb': rounds to nearest 5 (e.g. 137.3 → 135, 142.8 → 145, 140 → 140)",
        "Handles zero correctly (returns 0)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "File location: backend/src/lib/weightRounding.ts. Pure function, no dependencies. Use Math.round(weight / increment) * increment for rounding."
    },
    {
      "id": "US-013",
      "title": "Implement progression logic",
      "description": "As a developer, I need progression calculation so that after a workout, the correct training max increase is determined based on AMRAP performance.",
      "acceptanceCriteria": [
        "lib/progression.ts exports calculateProgression(amrapReps: number, exercise: 'bench' | 'squat' | 'ohp' | 'deadlift'): { increase: number }",
        "The increase value is in kg",
        "0-1 reps → increase = 0 (all exercises)",
        "2-3 reps → increase = 2.5 (all exercises)",
        "4-5 reps, upper body (bench, ohp) → increase = 2.5",
        "4-5 reps, lower body (squat, deadlift) → increase = 5",
        "6+ reps, upper body (bench, ohp) → increase = 5",
        "6+ reps, lower body (squat, deadlift) → increase = 7.5",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "File location: backend/src/lib/progression.ts. Pure function, no dependencies. Upper body = bench, ohp. Lower body = squat, deadlift. The exercise type determines the increment size at the 4-5 and 6+ rep thresholds."
    },
    {
      "id": "US-014",
      "title": "Define nSuns 4-day program constant",
      "description": "As a developer, I need a typed program definition so that workout generation can look up the correct exercises, percentages, and rep schemes for any training day.",
      "acceptanceCriteria": [
        "lib/nsuns.ts exports a NSUNS_4DAY constant with 4 days",
        "Each day has a T1 exercise slot (9 sets) and a T2 exercise slot (8 sets)",
        "Each exercise slot specifies: exerciseName (display name), exerciseKey (DB key like 'bench'), tmExercise (which TM to look up), and sets array",
        "Each set in the array specifies: percentage (decimal e.g. 0.65), reps (number), isAmrap (boolean)",
        "Day 1: T1 Bench Volume (bench TM) sets: 65%x8, 75%x6, 85%x4, 85%x4, 85%x4, 80%x5, 75%x6, 70%x7, 65%x8+(AMRAP). T2 OHP (ohp TM) sets: 50%x6, 60%x5, 70%x3, 70%x5, 70%x7, 70%x4, 70%x6, 70%x8",
        "Day 2: T1 Squat (squat TM) sets: 75%x5, 85%x3, 95%x1+(AMRAP), 90%x3, 85%x3, 80%x3, 75%x5, 70%x5, 65%x5+. T2 Sumo Deadlift (deadlift TM) sets: 50%x5, 60%x5, 70%x3, 70%x5, 70%x7, 70%x4, 70%x6, 70%x8",
        "Day 3: T1 Bench Heavy (bench TM) sets: 75%x5, 85%x3, 95%x1+(AMRAP), 90%x3, 85%x5, 80%x3, 75%x5, 70%x3, 65%x5+. T2 Close Grip Bench (bench TM) sets: 40%x6, 50%x5, 60%x3, 60%x5, 60%x7, 60%x4, 60%x6, 60%x8",
        "Day 4: T1 Deadlift (deadlift TM) sets: 75%x5, 85%x3, 95%x1+(AMRAP), 90%x3, 85%x3, 80%x3, 75%x3, 70%x3, 65%x3+. T2 Front Squat (squat TM) sets: 35%x5, 45%x5, 55%x3, 55%x5, 55%x7, 55%x4, 55%x6, 55%x8",
        "Types exported: SetScheme, ExerciseSlot, ProgramDay",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "File location: backend/src/lib/nsuns.ts. T2 TM references: OHP uses 'ohp', Sumo Deadlift uses 'deadlift', Close Grip Bench uses 'bench', Front Squat uses 'squat'. Day 1 has only one AMRAP (set 9 at 65%). Days 2-4 have two AMRAP-marked sets: the 95%x1+ (set 3) and a lighter final set with '+'. The highest-percentage AMRAP is the progression AMRAP (relevant for Epic 6, not this file). T1 exercise keys: Day 1 'bench', Day 2 'squat', Day 3 'bench', Day 4 'deadlift'. T2 exercise names for display: 'OHP', 'Sumo Deadlift', 'Close Grip Bench', 'Front Squat'."
    },
    {
      "id": "US-015",
      "title": "Implement workout set generation",
      "description": "As a developer, I need a function that takes a day number and training maxes and returns fully calculated workout sets, so the Workout API can persist them directly.",
      "acceptanceCriteria": [
        "lib/nsuns.ts exports generateWorkoutSets(dayNumber: number, trainingMaxes: Record<string, number>, unit: 'kg' | 'lb'): GeneratedSet[]",
        "GeneratedSet type includes: exercise (string key), tier ('T1' | 'T2'), setOrder (number, 1-indexed), prescribedWeight (number, in kg), prescribedReps (number), isAmrap (boolean)",
        "For each exercise slot in the day, looks up the correct TM by the slot's tmExercise key",
        "Calculates weight as roundWeight(tm * percentage, unit) — weights stored in kg but rounding granularity depends on unit",
        "T1 sets are numbered 1-9, T2 sets are numbered 1-8",
        "Returns all 17 sets for the day (9 T1 + 8 T2)",
        "Throws a clear error if day number is not 1-4",
        "Throws a clear error if required training maxes are missing for the day's exercises",
        "GeneratedSet type is exported",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "File location: backend/src/lib/nsuns.ts (same file as NSUNS_4DAY). Import roundWeight from ./weightRounding. The trainingMaxes parameter maps exercise keys to weights in kg (e.g. { bench: 90, squat: 126, ohp: 54, deadlift: 162 }). Day 2 needs 'squat' and 'deadlift' TMs. Day 1 needs 'bench' and 'ohp' TMs. Day 3 needs only 'bench' TM (both T1 and T2 use bench). Day 4 needs 'deadlift' and 'squat' TMs."
    },
    {
      "id": "US-016",
      "title": "Test all nSuns domain logic",
      "description": "As a developer, I need comprehensive tests for all domain logic to ensure correctness before integrating with the database layer.",
      "acceptanceCriteria": [
        "Tests for roundWeight: kg rounding (exact multiples, round up, round down, zero), lb rounding (exact multiples, round up, round down, zero)",
        "Tests for calculateProgression: every threshold boundary (0, 1, 2, 3, 4, 5, 6, 10 reps) for each of the 4 exercises",
        "Tests for NSUNS_4DAY: each day has correct T1/T2 exercise names and keys, correct number of sets (9 T1, 8 T2), AMRAP sets are in correct positions",
        "Tests for generateWorkoutSets: Day 2 with Squat TM=126kg produces set 3 weight of 120kg (95% of 126 = 119.7, rounded to 120), all 17 sets returned, correct tier and set ordering, lb rounding works correctly, invalid day number throws error, missing TM throws error",
        "All tests pass with npm test",
        "Tests pass"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Test files go in backend/src/__tests__/lib/. These are pure unit tests — no database needed. Create separate test files: weightRounding.test.ts, progression.test.ts, nsuns.test.ts. The test infrastructure (run_test.sh) will still run them but DB is not used. For generateWorkoutSets Day 2 test: trainingMaxes = { squat: 126, deadlift: 162 }. Expected T1 set 3 (95%): roundWeight(126 * 0.95, 'kg') = roundWeight(119.7, 'kg') = 120. Expected T2 set 1 (50% of deadlift TM): roundWeight(162 * 0.50, 'kg') = roundWeight(81, 'kg') = 81 (exact). Day 1 Bench Volume AMRAP is set 9 (65%). Days 2-4 AMRAP is set 3 (95%)."
    }
  ]
}
