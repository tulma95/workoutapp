{
  "project": "nSuns 4-Day LP Workout Tracker",
  "branchName": "ralph/authentication",
  "description": "Authentication System - JWT-based auth with register, login, refresh tokens, and protected routes",
  "userStories": [
    {
      "id": "US-001",
      "title": "Environment config and shared types",
      "description": "As a developer, I need centralized config loading and shared TypeScript types so the rest of the auth system has a solid foundation.",
      "acceptanceCriteria": [
        "Create src/config.ts that loads JWT_SECRET, DATABASE_URL, PORT, and NODE_ENV from environment variables",
        "Config throws a descriptive error at startup if JWT_SECRET or DATABASE_URL is missing",
        "Create src/types/index.ts with types: JwtPayload (userId, email), AuthRequest (extends Express Request with userId property)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Use dotenv which is already installed. Import config in index.ts to validate env vars at startup. For AuthRequest, extend express.Request. Check existing app.ts and index.ts for current patterns."
    },
    {
      "id": "US-002",
      "title": "Zod validation middleware",
      "description": "As a developer, I want a reusable validation middleware factory so that all routes can validate request bodies consistently using zod schemas.",
      "acceptanceCriteria": [
        "Create src/middleware/validate.ts exporting a validate(schema) function that returns Express middleware",
        "On valid input, parsed data is attached to req.body and next() is called",
        "On invalid input, responds with 400 and structured error: { error: { code: 'VALIDATION_ERROR', message: '...', details: [...] } } where details contains field-level errors",
        "Works with zod object schemas for request body validation",
        "Unit test: valid body passes through; invalid body returns 400 with correct error structure",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Zod v4 is installed (zod@4.3.6). Use z.ZodType or z.ZodSchema for the schema parameter type. For field-level errors, use ZodError's issues array. Place tests in src/__tests__/middleware/validate.test.ts. The project uses Express 5."
    },
    {
      "id": "US-003",
      "title": "Global error handler middleware",
      "description": "As a developer, I want a global error handler so that unhandled errors return a consistent JSON response instead of crashing or returning HTML.",
      "acceptanceCriteria": [
        "Create src/middleware/errorHandler.ts exporting an Express error-handling middleware (4-arg signature: err, req, res, next)",
        "Returns structured error: { error: { code: 'INTERNAL_ERROR', message: '...' } }",
        "In development (NODE_ENV=development), includes error stack in response",
        "In production, returns generic message without leaking internals",
        "Returns 500 status code for unhandled errors",
        "Unit test: error handler returns correct format in dev and production modes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Use the config module from US-001 to check NODE_ENV. Express 5 error middleware still uses the 4-arg signature. Place tests in src/__tests__/middleware/errorHandler.test.ts."
    },
    {
      "id": "US-004",
      "title": "JWT auth middleware",
      "description": "As a developer, I need middleware that verifies JWT tokens on protected routes so that only authenticated users can access them.",
      "acceptanceCriteria": [
        "Create src/middleware/auth.ts exporting an authenticate middleware",
        "Extracts token from Authorization: Bearer <token> header",
        "On valid token, attaches userId to the request object and calls next()",
        "Missing header returns 401: { error: { code: 'AUTH_REQUIRED', message: 'Authentication required' } }",
        "Invalid/expired token returns 401: { error: { code: 'TOKEN_INVALID', message: 'Invalid or expired token' } }",
        "Tests: valid token passes, missing token returns 401, expired token returns 401, malformed token returns 401",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Use jsonwebtoken (already installed). Use JWT_SECRET from config.ts. Use the AuthRequest type from types/index.ts. For tests, sign real JWTs with jsonwebtoken to test valid/expired cases. Place tests in src/__tests__/middleware/auth.test.ts."
    },
    {
      "id": "US-005",
      "title": "Auth service - register and login",
      "description": "As a developer, I need an auth service that handles the business logic of user registration and login, including password hashing and JWT signing.",
      "acceptanceCriteria": [
        "Create src/services/auth.service.ts with register() and login() functions",
        "register() hashes password with bcrypt, creates user in DB via Prisma, returns { accessToken, refreshToken, user } (user object excludes passwordHash)",
        "login() finds user by email, compares password with bcrypt, returns { accessToken, refreshToken, user } on success",
        "login() returns descriptive error if email not found or password wrong (same error message for both to avoid user enumeration)",
        "Access token expires in 24 hours, contains userId and email",
        "Refresh token expires in 30 days, contains userId and type: 'refresh' claim",
        "Tests: register creates user with hashed password; register rejects duplicate email; login succeeds with correct credentials; login fails with wrong password; login fails with unknown email; returned user object does not contain passwordHash",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Import Prisma client from lib/db.ts. Use bcrypt (already installed) for password hashing. Use jsonwebtoken for signing. Use JWT_SECRET from config.ts. Mock Prisma in tests using vi.mock('../lib/db'). The User model fields: id, email, passwordHash, displayName, unitPreference, createdAt, updatedAt."
    },
    {
      "id": "US-006",
      "title": "Auth routes - register and login endpoints",
      "description": "As a user, I want to register and log in via API endpoints so that I can create an account and authenticate.",
      "acceptanceCriteria": [
        "Create src/routes/auth.ts with Express router",
        "POST /api/auth/register accepts { email, password, displayName, unitPreference } with zod validation: email must be valid email, password min 8 chars, displayName non-empty string, unitPreference is 'kg' or 'lb'",
        "Returns 201 with { accessToken, refreshToken, user } on success",
        "Returns 409 with { error: { code: 'EMAIL_EXISTS', message: '...' } } for duplicate email",
        "POST /api/auth/login accepts { email, password } with zod validation",
        "Returns 200 with { accessToken, refreshToken, user } on success",
        "Returns 401 with { error: { code: 'AUTH_FAILED', message: 'Invalid email or password' } } on failure",
        "Integration tests with supertest: register success, register duplicate email, register invalid body, login success, login wrong password, login unknown email",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Use the validate middleware from US-002 for request validation. Use auth.service.ts from US-005 for business logic. Routes must be mounted at /api/auth in app.ts (US-009), but for integration tests use supertest with the router directly or mount temporarily. Handle Prisma unique constraint errors (P2002) for duplicate email detection."
    },
    {
      "id": "US-007",
      "title": "Token refresh endpoint",
      "description": "As a user, I want to refresh my access token using a refresh token so that I stay logged in without re-entering credentials.",
      "acceptanceCriteria": [
        "POST /api/auth/refresh accepts { refreshToken } with zod validation",
        "Verifies refresh token is valid and has type: 'refresh' claim",
        "Returns 200 with new { accessToken, refreshToken } (rotates both tokens)",
        "Returns 401 with { error: { code: 'TOKEN_INVALID', message: 'Invalid or expired refresh token' } } on failure",
        "Using an access token as a refresh token is rejected (no type: 'refresh' claim)",
        "Tests: refresh with valid token returns new tokens; refresh with expired token returns 401; refresh with access token (wrong type) returns 401",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Add the refresh route to the same src/routes/auth.ts router from US-006. Verify the decoded token has type === 'refresh' before issuing new tokens. Use jsonwebtoken.verify() to decode and validate."
    },
    {
      "id": "US-008",
      "title": "User routes - get and update profile",
      "description": "As a logged-in user, I want to view and update my profile so that I can see my account info and change my preferences.",
      "acceptanceCriteria": [
        "Create src/routes/users.ts with Express router",
        "GET /api/users/me (protected with authenticate middleware) returns current user object (excludes passwordHash)",
        "PATCH /api/users/me (protected) accepts optional { displayName, unitPreference } with zod validation",
        "Returns 200 with updated user object",
        "Only updates fields that are provided (partial update)",
        "unitPreference must be 'kg' or 'lb' if provided",
        "Integration tests: GET /me returns user; GET /me without token returns 401; PATCH /me updates displayName; PATCH /me updates unitPreference; PATCH /me with invalid unitPreference returns 400",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Use authenticate middleware from US-004 on all routes. Use Prisma's findUnique and update methods. For the user response, select specific fields or use destructuring to exclude passwordHash. Use validate middleware for PATCH body validation."
    },
    {
      "id": "US-009",
      "title": "Wire all routes into Express app",
      "description": "As a developer, I need all auth and user routes mounted in the Express app with the global error handler so the API is fully functional.",
      "acceptanceCriteria": [
        "Mount auth routes at /api/auth in app.ts",
        "Mount user routes at /api/users in app.ts",
        "Apply global error handler as last middleware in app.ts",
        "Existing health check endpoint (GET /api/health) still works",
        "Existing health check test still passes",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Import authRoutes from routes/auth and userRoutes from routes/users. Use app.use('/api/auth', authRoutes) and app.use('/api/users', userRoutes). The error handler must be registered AFTER all routes. Verify the health check test in src/__tests__/health.test.ts still passes."
    },
    {
      "id": "US-010",
      "title": "End-to-end auth flow verification",
      "description": "As a developer, I want to verify the complete auth flow works end-to-end so I'm confident the system is ready for dependent features.",
      "acceptanceCriteria": [
        "All unit and integration tests pass (npm test -w backend)",
        "Manual verification via curl: register -> login -> access GET /api/users/me -> refresh token -> access GET /api/users/me with new token",
        "Typecheck passes (npm run build -w backend)"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Run npm test -w backend to verify all tests. Run npm run build -w backend to verify typecheck. For manual curl test, start the server with npm run dev -w backend and run curl commands against localhost:3001. Docker must be running for database access."
    }
  ]
}
